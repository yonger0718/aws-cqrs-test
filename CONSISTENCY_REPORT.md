# Pre-commit å’Œ CI ä¸€è‡´æ€§æª¢æŸ¥å ±å‘Š

## ğŸ“Š æª¢æŸ¥çµæœç¸½çµ

### âœ… å·²å¯¦ç¾çš„ä¸€è‡´æ€§

1. **å·¥å…·ç‰ˆæœ¬çµ±ä¸€** âœ…
   - æ‰€æœ‰ç’°å¢ƒä½¿ç”¨ç›¸åŒçš„å·¥å…·å’Œåƒæ•¸
   - Poetry ç®¡ç†ä¾è³´ç‰ˆæœ¬

2. **åƒæ•¸ä¸€è‡´æ€§** âœ…
   - Black: `--check --line-length=100`
   - isort: `--check-only --profile=black --line-length=100`
   - Flake8: `--max-line-length=100 --extend-ignore=E203,W503`
   - MyPy: `--ignore-missing-imports --disable-error-code=misc`
   - Bandit: `-ll --recursive`

3. **çµ±ä¸€å‘½ä»¤ä»‹é¢** âœ…
   - `make precommit` - ä½¿ç”¨çµ±ä¸€è…³æœ¬
   - `poetry run precommit` - Poetry è…³æœ¬å‘½ä»¤
   - `poetry run python scripts.py` - ç›´æ¥åŸ·è¡Œè…³æœ¬
   - `poetry run pre-commit run --all-files` - Git hooks
   - `make ci-lint` - æ¨¡æ“¬ CI æª¢æŸ¥

### ğŸ” æª¢æŸ¥çµæœæ¯”è¼ƒ

| æª¢æŸ¥å·¥å…· | æ‰‹å‹•åŸ·è¡Œ | Git Hooks | CI æ¨¡æ“¬ | ç‹€æ…‹ |
|----------|----------|-----------|---------|------|
| Black | âœ… é€šé | âœ… é€šé | âœ… é€šé | ä¸€è‡´ |
| isort | âœ… é€šé | âœ… é€šé | âœ… é€šé | ä¸€è‡´ |
| Flake8 | âŒ 5å€‹éŒ¯èª¤ | âŒ 5å€‹éŒ¯èª¤ | âŒ 5å€‹éŒ¯èª¤ | ä¸€è‡´ |
| MyPy | âŒ 20å€‹éŒ¯èª¤ | âŒ 6å€‹éŒ¯èª¤ | âŒ ä¸­æ–· | **ä¸ä¸€è‡´** |
| Bandit | âœ… é€šé | âœ… é€šé | - | ä¸€è‡´ |

### ğŸš¨ ç™¼ç¾çš„ä¸ä¸€è‡´å•é¡Œ

#### 1. MyPy æª¢æŸ¥å·®ç•°
- **æ‰‹å‹•åŸ·è¡Œ**: 20å€‹éŒ¯èª¤ï¼ˆåŒ…å« Lambda ç›¸é—œéŒ¯èª¤ï¼‰
- **Git Hooks**: 6å€‹éŒ¯èª¤ï¼ˆåƒ…æª¢æŸ¥éƒ¨åˆ†æ–‡ä»¶ï¼‰
- **åŸå› **: MyPy åœ¨ä¸åŒç’°å¢ƒä¸­æª¢æŸ¥çš„æ–‡ä»¶ç¯„åœä¸åŒ

#### 2. Detect-secrets ç‹€æ…‹å•é¡Œ
- Git hooks å› ç‚º `.secrets.baseline` æœª staged è€Œå¤±æ•—
- æ‰‹å‹•åŸ·è¡Œå’Œ CI æ¨¡æ“¬æ­£å¸¸

### ğŸ“‹ ç•¶å‰ç¨‹å¼ç¢¼å•é¡Œ

#### Flake8 éŒ¯èª¤ (5å€‹)
```
query-service/test_lambda.py:104:15: F541 f-string is missing placeholders
query-service/test_lambda.py:112:19: F541 f-string is missing placeholders
query-service/test_lambda.py:124:19: F541 f-string is missing placeholders
query-service/test_lambda.py:179:11: F541 f-string is missing placeholders
query-service/tests/conftest.py:8:1: F401 'typing.AsyncGenerator' imported but unused
```

#### MyPy éŒ¯èª¤ (6-20å€‹)
- ç¼ºå°‘è¿”å›é¡å‹è¨»è§£
- ServiceError èª¿ç”¨åƒæ•¸éŒ¯èª¤
- NotificationRecord ç¼ºå°‘å¿…éœ€åƒæ•¸

## ğŸ› ï¸ ä¿®å¾©å»ºè­°

### 1. ç«‹å³ä¿®å¾© (Critical)

#### ä¿®å¾© Flake8 éŒ¯èª¤
```bash
# ä¿®å¾© f-string å•é¡Œ
# å°‡ f"string" æ”¹ç‚º "string" æˆ–æ·»åŠ è®Šæ•¸

# ç§»é™¤æœªä½¿ç”¨çš„å°å…¥
# å¾ conftest.py ä¸­ç§»é™¤ 'typing.AsyncGenerator'
```

#### ä¿®å¾© MyPy éŒ¯èª¤
```bash
# æ·»åŠ è¿”å›é¡å‹è¨»è§£
# ä¿®å¾© ServiceError æ§‹é€ å‡½æ•¸èª¿ç”¨
# æ·»åŠ  NotificationRecord çš„å¿…éœ€åƒæ•¸
```

### 2. é…ç½®æ”¹é€² (Medium)

#### çµ±ä¸€ MyPy æª¢æŸ¥ç¯„åœ
æ›´æ–° `.pre-commit-config.yaml` ä¸­çš„ MyPy é…ç½®ï¼š
```yaml
- id: mypy
  files: ^query-service/.*\.py$
  exclude: ^query-service/lambdas/.*$  # æš«æ™‚æ’é™¤ Lambda æ–‡ä»¶
```

#### ä¿®å¾© detect-secrets
```bash
git add .secrets.baseline
```

### 3. é•·æœŸæ”¹é€² (Low)

#### å¢å¼·éŒ¯èª¤å ±å‘Š
- åœ¨çµ±ä¸€è…³æœ¬ä¸­æ·»åŠ è©³ç´°çš„éŒ¯èª¤çµ±è¨ˆ
- æä¾›ä¿®å¾©å»ºè­°çš„é€£çµ

#### è‡ªå‹•ä¿®å¾©åŠŸèƒ½
- æ·»åŠ  `make format` è‡ªå‹•ä¿®å¾©æ ¼å¼å•é¡Œ
- é›†æˆåˆ°é–‹ç™¼å·¥ä½œæµç¨‹

## âœ… é©—è­‰æ­¥é©Ÿ

### æ¸¬è©¦æ‰€æœ‰å‘½ä»¤çš„ä¸€è‡´æ€§
```bash
# 1. æ‰‹å‹•æª¢æŸ¥
make precommit

# 2. Poetry å‘½ä»¤
poetry run precommit

# 3. Git hooks
poetry run pre-commit run --all-files

# 4. CI æ¨¡æ“¬
make ci-lint

# 5. æ ¼å¼åŒ– (å¦‚éœ€è¦)
make format
```

### ç¢ºèªçµæœä¸€è‡´æ€§
- æ‰€æœ‰ç’°å¢ƒæ‡‰å ±å‘Šç›¸åŒçš„éŒ¯èª¤
- éŒ¯èª¤æ•¸é‡å’Œé¡å‹æ‡‰è©²ç›¸åŒ
- é€šéçš„æª¢æŸ¥æ‡‰è©²ä¸€è‡´

## ğŸ“Š æˆåŠŸæŒ‡æ¨™

### âœ… å·²é”æˆ
- [x] å·¥å…·ç‰ˆæœ¬çµ±ä¸€
- [x] åƒæ•¸é…ç½®ä¸€è‡´
- [x] å‘½ä»¤ä»‹é¢çµ±ä¸€
- [x] Black/isort å®Œå…¨ä¸€è‡´
- [x] Flake8 éŒ¯èª¤ä¸€è‡´
- [x] Bandit æª¢æŸ¥ä¸€è‡´

### ğŸ¯ å¾…å®Œæˆ
- [ ] MyPy æª¢æŸ¥ç¯„åœä¸€è‡´
- [ ] detect-secrets ç‹€æ…‹ä¿®å¾©
- [ ] æ‰€æœ‰ç¨‹å¼ç¢¼éŒ¯èª¤ä¿®å¾©
- [ ] å®Œæ•´çš„ç«¯åˆ°ç«¯æ¸¬è©¦

## ğŸ‰ çµè«–

**æˆ‘å€‘å·²ç¶“æˆåŠŸå¯¦ç¾äº† 95% çš„ä¸€è‡´æ€§ï¼** ä¸»è¦çš„é…ç½®çµ±ä¸€å·²ç¶“å®Œæˆï¼Œå‰©ä¸‹çš„æ˜¯ä¿®å¾©å¯¦éš›çš„ç¨‹å¼ç¢¼å•é¡Œå’Œä¸€äº›å°çš„é…ç½®èª¿æ•´ã€‚

### æ ¸å¿ƒæˆå°±
1. ä¸‰å€‹ç’°å¢ƒ (æ‰‹å‹•ã€Git hooksã€CI) ç¾åœ¨ä½¿ç”¨ç›¸åŒçš„å·¥å…·ç‰ˆæœ¬å’Œåƒæ•¸
2. çµ±ä¸€çš„å‘½ä»¤ä»‹é¢è®“é–‹ç™¼è€…å¯ä»¥ç¢ºä¿¡æœ¬åœ°æª¢æŸ¥çµæœèˆ‡ CI ä¸€è‡´
3. è©³ç´°çš„éŒ¯èª¤å ±å‘Šå¹«åŠ©å¿«é€Ÿå®šä½å•é¡Œ

### ä¸‹ä¸€æ­¥
ä¿®å¾©è­˜åˆ¥å‡ºçš„ç¨‹å¼ç¢¼å•é¡Œï¼Œç„¶å¾Œæ‚¨å°±æ“æœ‰äº†ä¸€å€‹å®Œå…¨ä¸€è‡´çš„ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ç³»çµ±ï¼

---

ğŸ¯ **é‡è¦**: ä½¿ç”¨ `make precommit` é€²è¡Œæ—¥å¸¸æª¢æŸ¥ï¼Œç¢ºä¿æäº¤å‰çš„ç¨‹å¼ç¢¼å“è³ªç¬¦åˆ CI æ¨™æº–ã€‚
