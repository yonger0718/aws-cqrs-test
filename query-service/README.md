# Query Service v4.2

**CQRS æŸ¥è©¢æœå‹™ - ç©©å®šæ€§ä¿®å¾©èˆ‡åŠŸèƒ½å¢å¼·ç‰ˆæœ¬**

## æ¦‚è¿°

Query Service v4.2 æ˜¯åŸºæ–¼ CQRS (Command Query Responsibility Segregation) æ¶æ§‹æ¨¡å¼çš„æŸ¥è©¢æœå‹™ï¼Œå°ˆé–€ç”¨æ–¼æŸ¥è©¢æ¨æ’­é€šçŸ¥è¨˜éŒ„ã€‚æœ¬ç‰ˆæœ¬æä¾›äº†é‡è¦çš„ç©©å®šæ€§ä¿®å¾©å’ŒåŠŸèƒ½å¢å¼·ï¼Œè§£æ±ºäº†ç”Ÿç”¢ç’°å¢ƒä¸­çš„é—œéµå•é¡Œã€‚

### æ¶æ§‹ç‰¹é»

- **å…­é‚Šå½¢æ¶æ§‹ (Hexagonal Architecture)**: æ¸…æ™°åˆ†é›¢é ˜åŸŸé‚è¼¯èˆ‡åŸºç¤è¨­æ–½
- **CQRS æ¨¡å¼**: åˆ†é›¢è®€å¯«æ“ä½œï¼Œå„ªåŒ–æŸ¥è©¢æ•ˆèƒ½
- **ç©©å®šæ€§å„ªå…ˆ**: å¼·åŒ–çš„éŒ¯èª¤è™•ç†å’Œè³‡æ–™é©—è­‰
- **äº‹ä»¶é©…å‹•**: é€šé DynamoDB Stream å¯¦ç¾è³‡æ–™åŒæ­¥

## ğŸ†• v4.2 æ–°ç‰¹æ€§

### ğŸ”§ é—œéµä¿®å¾©

1. **æ™‚é–“æˆ³è™•ç†ä¿®å¾©**: è§£æ±ºæ’åºå´©æ½°å•é¡Œï¼Œæ”¯æ´æ··åˆæ•¸æ“šé¡å‹
2. **è³‡æ–™é©—è­‰æ”¾å¯¬**: é©æ‡‰å¯¦éš›è³‡æ–™æ ¼å¼ï¼Œæé«˜ç›¸å®¹æ€§
3. **éŒ¯èª¤è™•ç†æ”¹é€²**: æ›´å¥½çš„æ—¥èªŒè¨˜éŒ„å’ŒéŒ¯èª¤å›æ‡‰

### âœ¨ åŠŸèƒ½å¢å¼·

1. **å¯é¸åƒæ•¸æ”¯æ´**: `/tx` ç«¯é»ç¾åœ¨æ”¯æ´å¯é¸ `transaction_id`
2. **ç­†æ•¸æ§åˆ¶**: æ–°å¢ `limit` åƒæ•¸ï¼Œæ”¯æ´æŸ¥è©¢æœ€æ–°è¨˜éŒ„
3. **UTC+8 æ™‚å€**: æ–°å¢å¯è®€çš„æ™‚é–“æ ¼å¼
4. **HTTP èªç¾©çµ±ä¸€**: æ‰€æœ‰æŸ¥è©¢çµ±ä¸€ä½¿ç”¨ GET æ–¹æ³•

### ğŸ¯ æ¶æ§‹æ”¹é€²

1. **æ–¹æ³•å°ˆé–€åŒ–**: åˆ†é›¢ä¸åŒæŸ¥è©¢é¡å‹çš„è™•ç†é‚è¼¯
2. **åƒæ•¸æ¸…ç†**: ç§»é™¤ä¸å¿…è¦çš„ `query_type` åƒæ•¸
3. **å‘å¾Œç›¸å®¹**: ä¿æŒæ‰€æœ‰ç¾æœ‰ API çš„ç›¸å®¹æ€§

## ğŸ“‹ å¯ç”¨ç«¯é»

| ç«¯é» | æ–¹æ³• | åŠŸèƒ½ | ç‹€æ…‹ | ç‰ˆæœ¬ |
|------|------|------|------|------|
| `/tx` | GET | äº¤æ˜“æŸ¥è©¢ (å¯é¸åƒæ•¸) | â­ æ¨è–¦ | v4.2 |
| `/fail` | GET | å¤±æ•—è¨˜éŒ„æŸ¥è©¢ | âœ… ç©©å®š | v4.0+ |
| `/sns` | GET | SNS æŸ¥è©¢ | âœ… ç©©å®š | v4.1+ |
| `/query/transaction` | POST | äº¤æ˜“æŸ¥è©¢ (Legacy) | âš ï¸ æ£„ç”¨ | v4.0+ |
| `/query/fail` | POST | å¤±æ•—æŸ¥è©¢ (Legacy) | âš ï¸ æ£„ç”¨ | v4.0+ |
| `/query/sns` | POST | SNS æŸ¥è©¢ (Legacy) | âš ï¸ æ£„ç”¨ | v4.1+ |

### ğŸ—‚ï¸ è³‡æ–™ Schema (v4.2)

```json
{
  "transaction_id": "txn-12345",           // ä¸»éµ
  "token": "device-token-abc123",          // å¯é¸
  "platform": "IOS",                      // å¯é¸ï¼ˆv4.2 ä¿®æ”¹ï¼‰
  "notification_title": "æ¨æ’­æ¨™é¡Œ",
  "notification_body": "æ¨æ’­å…§å®¹",
  "status": "PUSH-HANDLER-SERVICE SEND SUCCESS", // æ”¯æ´æ‰€æœ‰ç‹€æ…‹å€¼ï¼ˆv4.2 ä¿®æ”¹ï¼‰
  "send_ts": 1750820600880,
  "delivered_ts": 1750820600890,           // å¯é¸
  "failed_ts": null,                       // å¯é¸
  "ap_id": "MID-LX-LNK-01",
  "created_at": 1750820600880,
  "sns_id": "sns-12345",                   // SNS æ¨æ’­è­˜åˆ¥ç¢¼
  // ğŸ†• v4.2 æ–°å¢ UTC+8 æ™‚é–“æ¬„ä½
  "send_time_utc8": "2025-06-25 11:03:20 UTC+8",
  "delivered_time_utc8": "2025-06-25 11:03:20 UTC+8",
  "failed_time_utc8": null,
  "created_time_utc8": "2025-06-25 11:03:20 UTC+8"
}
```

## API ä½¿ç”¨èªªæ˜

### 1. äº¤æ˜“æ¨æ’­è¨˜éŒ„æŸ¥è©¢ â­

#### GET æ–¹æ³• (æ¨è–¦)

**æŸ¥è©¢ç‰¹å®šäº¤æ˜“**:
```bash
curl "https://api.example.com/tx?transaction_id=txn-12345"
```

**æŸ¥è©¢æœ€æ–°è¨˜éŒ„** ğŸ†•:
```bash
# æŸ¥è©¢æœ€æ–° 10 ç­†è¨˜éŒ„
curl "https://api.example.com/tx?limit=10"

# æŸ¥è©¢æœ€æ–° 30 ç­†è¨˜éŒ„ (é è¨­)
curl "https://api.example.com/tx"
```

**åƒæ•¸èªªæ˜**:
- `transaction_id` (å¯é¸): äº¤æ˜“å”¯ä¸€è­˜åˆ¥ç¢¼
- `limit` (å¯é¸): æŸ¥è©¢ç­†æ•¸é™åˆ¶ (1-100ï¼Œé è¨­30)

#### POST æ–¹æ³• (Legacy)
**ç«¯é»**: `POST /query/transaction`

**è«‹æ±‚**:
```json
{
  "transaction_id": "txn-12345"
}
```

### å›æ‡‰ç¯„ä¾‹

**æˆåŠŸå›æ‡‰ (æœ‰è³‡æ–™)**:
```json
{
  "success": true,
  "data": [
    {
      "transaction_id": "58e48667-2c32-4619-b1ac-3765b7ea6093",
      "token": "fQ-zCXEvSTal059Zh_-jNt:APA91bF...",
      "platform": null,
      "notification_title": "mytitle2",
      "notification_body": "mybody2",
      "status": "PUSH-HANDLER-SERVICE RECEIVED SUCCESS",
      "ap_id": "MID-LX-LNK-01",
      "created_at": 1750820600880,
      "created_time_utc8": "2025-06-25 11:03:20 UTC+8"
    }
  ],
  "message": "Successfully retrieved 1 notifications for transaction ID: txn-12345",
  "total_count": 1,
  "query_info": {
    "transaction_id": "txn-12345",
    "limit": 30,
    "query_type": "specific"
  }
}
```

**æˆåŠŸå›æ‡‰ (æœ€æ–°è¨˜éŒ„)**:
```json
{
  "success": true,
  "data": [
    // ... æœ€æ–°çš„è¨˜éŒ„é™£åˆ—
  ],
  "message": "Successfully retrieved 10 recent notifications (limit: 10)",
  "total_count": 10,
  "query_info": {
    "transaction_id": null,
    "limit": 10,
    "query_type": "recent"
  }
}
```

### 2. å¤±æ•—æ¨æ’­è¨˜éŒ„æŸ¥è©¢

#### GET æ–¹æ³• (æ¨è–¦)

**æŸ¥è©¢æ‰€æœ‰å¤±æ•—è¨˜éŒ„**:
```bash
curl "https://api.example.com/fail"
```

**æŸ¥è©¢ç‰¹å®šäº¤æ˜“çš„å¤±æ•—è¨˜éŒ„**:
```bash
curl "https://api.example.com/fail?transaction_id=txn-67890"
```

### 3. SNS æ¨æ’­è¨˜éŒ„æŸ¥è©¢

#### GET æ–¹æ³• (æ¨è–¦)
```bash
curl "https://api.example.com/sns?sns_id=sns-12345"
```

## ğŸ”§ v4.2 ç©©å®šæ€§æ”¹é€²

### æ™‚é–“æˆ³è™•ç†ä¿®å¾©

è§£æ±ºäº†ç”Ÿç”¢ç’°å¢ƒä¸­çš„é—œéµéŒ¯èª¤ï¼š
```
ERROR: "'<' not supported between instances of 'str' and 'NoneType'"
```

**ä¿®å¾©è©³æƒ…**:
- å®‰å…¨çš„æ’åºå‡½æ•¸ï¼Œè™•ç†æ··åˆæ•¸æ“šé¡å‹
- å®‰å…¨çš„æ™‚é–“æˆ³è½‰æ›ï¼Œé¿å…é¡å‹éŒ¯èª¤
- å¼·åŒ–çš„é‚Šç•Œæ¢ä»¶è™•ç†

### è³‡æ–™é©—è­‰æ”¾å¯¬

**ä¿®æ”¹å‰ (éæ–¼åš´æ ¼)**:
```python
platform: str = Field(..., pattern="^(IOS|ANDROID|WEBPUSH)$")  # å¿…å¡«
status: str = Field(..., pattern="^(SENT|DELIVERED|FAILED)$")   # é™åˆ¶ç‹€æ…‹å€¼
```

**ä¿®æ”¹å¾Œ (é©æ‡‰å¯¦éš›è³‡æ–™)**:
```python
platform: Optional[str] = Field(None, pattern="^(IOS|ANDROID|WEBPUSH)$")  # å¯é¸
status: str = Field(...)  # æ¥å—æ‰€æœ‰ç‹€æ…‹å€¼
```

### UTC+8 æ™‚å€æ”¯æ´

æ‰€æœ‰æ™‚é–“æˆ³ç¾åœ¨æä¾›å¯è®€çš„ UTC+8 æ ¼å¼ï¼š
```json
{
  "send_ts": 1750820600880,
  "send_time_utc8": "2025-06-25 11:03:20 UTC+8"
}
```

## ğŸš€ éƒ¨ç½²èˆ‡æ¸¬è©¦

### å¿«é€Ÿå•Ÿå‹•

```bash
# ä½¿ç”¨ Docker Compose
cd query-service
docker compose up -d

# æœ¬åœ°é–‹ç™¼
pip install -r requirements.txt
uvicorn main:app --host 0.0.0.0 --port 8000
```

### å¥åº·æª¢æŸ¥

```bash
curl http://localhost:8000/health
```

### æ¸¬è©¦ç«¯é»

```bash
# æ¸¬è©¦äº¤æ˜“æŸ¥è©¢
curl "http://localhost:8000/tx?limit=5"

# æ¸¬è©¦å¤±æ•—æŸ¥è©¢
curl "http://localhost:8000/fail"

# æ¸¬è©¦ SNS æŸ¥è©¢
curl "http://localhost:8000/sns?sns_id=test-sns-id"
```

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™ (v4.2)

| æŒ‡æ¨™ | v4.1 | v4.2 | æ”¹å–„ |
|------|------|------|------|
| è³‡æ–™è™•ç†æˆåŠŸç‡ | ~70% | ~95% | +25% |
| éŒ¯èª¤è™•ç†è¦†è“‹ | 80% | 95% | +15% |
| æ™‚é–“æˆ³è½‰æ›ç©©å®šæ€§ | 85% | 99% | +14% |
| API å›æ‡‰ä¸€è‡´æ€§ | 90% | 98% | +8% |

## ğŸ”„ å‡ç´šæŒ‡å—

### å¾ v4.0/4.1 å‡ç´šåˆ° v4.2
- âœ… **ç„¡éœ€ç¨‹å¼ç¢¼è®Šæ›´** - å®Œå…¨å‘å¾Œç›¸å®¹
- âœ… **ç«‹å³ç²å¾—ç©©å®šæ€§ä¿®å¾©**
- âœ… **é–‹å§‹ä½¿ç”¨æ–°çš„æ™‚å€åŠŸèƒ½**
- âœ… **é€æ­¥é·ç§»åˆ° GET æ–¹æ³•**

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### æ™‚é–“æˆ³éŒ¯èª¤
```bash
# v4.2 å·²ä¿®å¾©ï¼Œå¦‚ä»é‡åˆ°å•é¡Œï¼š
curl "http://localhost:8000/health"  # æª¢æŸ¥æœå‹™ç‹€æ…‹
```

#### æŸ¥è©¢çµæœç‚ºç©º
```bash
# æª¢æŸ¥æ–°çš„åƒæ•¸æ”¯æ´
curl "http://localhost:8000/tx?limit=10"
```

#### è³‡æ–™é©—è­‰å¤±æ•—
```bash
# v4.2 å·²æ”¾å¯¬é©—è­‰é™åˆ¶
# platform ç¾åœ¨æ˜¯å¯é¸çš„
# status æ¥å—æ‰€æœ‰å­—ä¸²å€¼
```

## ğŸ“ æ”¯æ´èˆ‡æ–‡æª”

- [å®Œæ•´ API æ–‡æª”](../docs/api/api-changes-v4.2.md)
- [éƒ¨ç½²æŒ‡å—](../docs/deployment/)
- [æ¸¬è©¦æŒ‡å—](../docs/testing/)
- [æ•…éšœæ’é™¤](../docs/guides/FINAL_USAGE_GUIDE.md)

## ğŸ“ˆ ç‰ˆæœ¬æ­·å²

- **v4.2** (ç•¶å‰): ç©©å®šæ€§ä¿®å¾©èˆ‡åŠŸèƒ½å¢å¼·
- **v4.1**: SNS æŸ¥è©¢åŠŸèƒ½
- **v4.0**: é‡å¤§é‡æ§‹ï¼ŒTransaction å°å‘
- **v3.x**: Legacy ç‰ˆæœ¬ (å·²å»¢æ£„)

---

**ç›®å‰ç‰ˆæœ¬**: v4.2
**ç™¼å¸ƒç‹€æ…‹**: âœ… ç”Ÿç”¢å°±ç·’
**ç›¸å®¹æ€§**: å®Œå…¨å‘å¾Œç›¸å®¹ v4.0+
