# CQRS + å…­é‚Šå½¢æ¶æ§‹è¨­è¨ˆæ–‡æª” - V4 ç‰ˆæœ¬

## æ¦‚è¿°

æœ¬å°ˆæ¡ˆ V4 ç‰ˆæœ¬å¯¦ç¾äº†é‡æ–°è¨­è¨ˆçš„ **CQRS (Command Query Responsibility Segregation)** èˆ‡ **å…­é‚Šå½¢æ¶æ§‹ (Hexagonal Architecture)** çµåˆï¼Œå°ˆæ³¨æ–¼ `transaction_id` ç‚ºä¸­å¿ƒçš„ç°¡åŒ–æŸ¥è©¢ç³»çµ±ï¼Œç”¨æ–¼æ§‹å»ºé«˜æ€§èƒ½ã€å¯ç¶­è­·çš„æ¨æ’­é€šçŸ¥æŸ¥è©¢æœå‹™ã€‚

## ğŸ“ V4 è¨­è¨ˆåŸå‰‡

### CQRS ç°¡åŒ–åŸå‰‡

- **å°ˆæ³¨è®€å–**: Query Side å°ˆé–€è™•ç†ä»¥ `transaction_id` ç‚ºæ ¸å¿ƒçš„æŸ¥è©¢
- **äº‹ä»¶é©…å‹•**: ç¶­æŒ DynamoDB Stream é€²è¡Œç•°æ­¥è³‡æ–™åŒæ­¥
- **æœ€çµ‚ä¸€è‡´æ€§**: æŸ¥è©¢ç«¯èˆ‡å‘½ä»¤ç«¯ä¿æŒæ•¸æ“šä¸€è‡´æ€§
- **ç°¡åŒ–æ¨¡å‹**: çµ±ä¸€çš„ `NotificationRecord` é ˜åŸŸæ¨¡å‹

### å…­é‚Šå½¢æ¶æ§‹ç²¾ç°¡åŒ–

- **æ ¸å¿ƒé ˜åŸŸ**: ç°¡åŒ–çš„æ¥­å‹™é‚è¼¯ï¼Œå°ˆæ³¨æ–¼é€šçŸ¥è¨˜éŒ„æŸ¥è©¢
- **æ¸…æ™°ç«¯å£**: æ˜ç¢ºçš„ `QueryPort` å’Œ `InternalAPIInvokerPort` ä»‹é¢
- **ä¾è³´åè½‰**: Internal API Gateway é©é…å™¨å¯¦ç¾
- **å¯æ¸¬è©¦æ€§**: Mock å‹å¥½çš„ä¾è³´æ³¨å…¥è¨­è¨ˆ

## ğŸ—ï¸ V4 ç³»çµ±æ¶æ§‹åœ–

```txt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   V4 å…­é‚Šå½¢æ¶æ§‹ + CQRS                          â”‚
â”‚                  (Transaction-centric Design)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Command Side  â”‚â”€â”€â”€â–¶â”‚  DynamoDB    â”‚â”€â”€â”€â–¶â”‚   Query Side    â”‚ â”‚
â”‚  â”‚   (Write Path)  â”‚    â”‚   Stream     â”‚    â”‚   (Read Path)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                      â”‚                      â”‚       â”‚
â”‚           â–¼                      â–¼                      â–¼       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ command-    â”‚      â”‚   Stream    â”‚      â”‚notification-â”‚    â”‚
â”‚    â”‚ records     â”‚      â”‚ Processor   â”‚      â”‚ records     â”‚    â”‚
â”‚    â”‚ (Write DB)  â”‚      â”‚  Lambda     â”‚      â”‚ (Read DB)   â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              V4 ECS FastAPI Query Service                      â”‚
â”‚                     (å…­é‚Šå½¢æ¶æ§‹)                                â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Web Layer (FastAPI)                     â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚ GET /tx     â”‚              â”‚ GET /fail   â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ POST /query/â”‚              â”‚ POST /query/â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ transaction â”‚              â”‚ fail        â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚ GET /health â”‚              â”‚ GET /       â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚               Application Layer (Services)                  â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                 QueryService                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ query_transaction_  â”‚  â”‚ query_failed_       â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ notifications()     â”‚  â”‚ notifications()     â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                              â”‚                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                   QueryPort                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                  (Interface)                            â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 Domain Layer (Models)                      â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚  NotificationRecord â”‚      â”‚    QueryResult      â”‚      â”‚ â”‚
â”‚  â”‚  â”‚                     â”‚      â”‚                     â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ transaction_id    â”‚      â”‚ â€¢ success: bool     â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ token             â”‚      â”‚ â€¢ data: List[...]   â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ platform          â”‚      â”‚ â€¢ message: str      â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ status            â”‚      â”‚ â€¢ total_count: int  â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ notification_*    â”‚      â”‚                     â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ timestamps        â”‚      â”‚                     â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ ap_id             â”‚      â”‚                     â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Infrastructure Layer (Adapters)                 â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚            InternalAPIAdapter                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ invoke_query_api() â”‚ â”€â”€â”€â”€â–¶â”‚ HTTP Client       â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                   â”‚      â”‚ (httpx)           â”‚      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                        â”‚                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚            Endpoint Mapping                      â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  "transaction" â†’ "/tx"                           â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  "fail" â†’ "/fail"                                â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                              â”‚                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚        InternalAPIInvokerPort                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚               (Interface)                               â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚           Internal API Gateway                          â”‚   â”‚
â”‚    â”‚              HTTP Endpoints                             â”‚   â”‚
â”‚    â”‚         /tx?transaction_id=...                          â”‚   â”‚
â”‚    â”‚         /fail?transaction_id=...                        â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ V4 æ ¸å¿ƒçµ„ä»¶

### 1. Command Side (å¯«å…¥ç«¯) - ä¿æŒä¸è®Š

**è³‡æ–™è¡¨**: `command-records`

- **ä¸»éµ**: `transaction_id` (PK) + `created_at` (SK)
- **åŠŸèƒ½**: è™•ç†æ‰€æœ‰å¯«å…¥æ“ä½œ
- **Stream**: å•Ÿç”¨ DynamoDB Stream è§¸ç™¼åŒæ­¥

### 2. Query Side (æŸ¥è©¢ç«¯) - ç°¡åŒ–è¨­è¨ˆ

**è³‡æ–™è¡¨**: `notification-records`

- **ä¸»éµ**: `transaction_id` (PK) + `created_at` (SK)
- **åŠŸèƒ½**: ä»¥ `transaction_id` ç‚ºä¸­å¿ƒçš„æŸ¥è©¢æ“ä½œ
- **æŸ¥è©¢æ¨¡å¼**:
  - **äº¤æ˜“æŸ¥è©¢**: æ ¹æ“š `transaction_id` æŸ¥è©¢æ‰€æœ‰ç›¸é—œæ¨æ’­è¨˜éŒ„
  - **å¤±æ•—æŸ¥è©¢**: æ ¹æ“š `transaction_id` + `status=FAILED` æŸ¥è©¢å¤±æ•—è¨˜éŒ„

### 3. Stream Processor (äº‹ä»¶è™•ç†å™¨) - ä¿æŒå…­é‚Šå½¢æ¶æ§‹

**Lambda å‡½æ•¸**: `stream_processor_lambda`

- **è§¸ç™¼**: DynamoDB Stream äº‹ä»¶
- **åŠŸèƒ½**: å°‡ Command Side æ•¸æ“šè½‰æ›ä¸¦åŒæ­¥åˆ° Query Side
- **æ¶æ§‹**: ç¶­æŒå…­é‚Šå½¢æ¶æ§‹è¨­è¨ˆ

### 4. ECS FastAPI Query Service (æŸ¥è©¢æœå‹™) - V4 ç°¡åŒ–å¯¦ç¾

**ECS Handler**: `eks_handler/main.py`

- **æ¶æ§‹**: å…­é‚Šå½¢æ¶æ§‹ V4
- **ç°¡åŒ–å±¤æ¬¡**: Web â†’ Application â†’ Domain â†’ Infrastructure
- **æ–°ç‰¹è‰²**: Internal API Gateway æ•´åˆ

## ğŸ”§ V4 å…­é‚Šå½¢æ¶æ§‹å¯¦ç¾

### Domain Layer (é ˜åŸŸå±¤) - çµ±ä¸€æ¨¡å‹

```python
class NotificationRecord(BaseModel):
    """æ¨æ’­è¨˜éŒ„é ˜åŸŸæ¨¡å‹ - V4 çµ±ä¸€è¨­è¨ˆ"""

    transaction_id: str = Field(..., description="å”¯ä¸€äº‹ä»¶è­˜åˆ¥ç¢¼")
    token: Optional[str] = Field(None, description="æ¨æ’­ token")
    platform: str = Field(..., pattern="^(IOS|ANDROID|WEBPUSH)$")
    notification_title: str = Field(..., description="æ¨æ’­æ¨™é¡Œ")
    notification_body: str = Field(..., description="æ¨æ’­å…§å®¹")
    status: str = Field(..., pattern="^(SENT|DELIVERED|FAILED)$")
    send_ts: Optional[int] = Field(None, description="é€å‡ºæ™‚é–“æˆ³")
    delivered_ts: Optional[int] = Field(None, description="é€é”æ™‚é–“æˆ³")
    failed_ts: Optional[int] = Field(None, description="å¤±æ•—æ™‚é–“æˆ³")
    ap_id: Optional[str] = Field(None, description="ä¾†æºæœå‹™è­˜åˆ¥ç¢¼")
    created_at: int = Field(..., description="å»ºç«‹æ™‚é–“æˆ³")

class QueryResult(BaseModel):
    """çµ±ä¸€æŸ¥è©¢çµæœæ¨¡å‹"""

    success: bool
    data: List[NotificationRecord] = []
    message: str = ""
    total_count: int = 0
```

### Application Layer (æ‡‰ç”¨å±¤) - ç°¡åŒ–æœå‹™

```python
class QueryPort(ABC):
    """æŸ¥è©¢æœå‹™ç«¯å£æ¥å£ - V4 ç°¡åŒ–ç‰ˆæœ¬"""

    @abstractmethod
    async def query_transaction_notifications(self, transaction_id: str) -> QueryResult:
        """æŸ¥è©¢äº¤æ˜“æ¨æ’­è¨˜éŒ„"""
        pass

    @abstractmethod
    async def query_failed_notifications(self, transaction_id: str) -> QueryResult:
        """æŸ¥è©¢å¤±æ•—æ¨æ’­è¨˜éŒ„"""
        pass

class QueryService(QueryPort):
    """æŸ¥è©¢æ‡‰ç”¨æœå‹™å¯¦ç¾ - V4"""

    def __init__(self, internal_api_adapter: InternalAPIInvokerPort):
        self.internal_api_adapter = internal_api_adapter

    async def query_transaction_notifications(self, transaction_id: str) -> QueryResult:
        """æŸ¥è©¢äº¤æ˜“æ¨æ’­è¨˜éŒ„"""
        try:
            result = await self.internal_api_adapter.invoke_query_api(
                "transaction", {"transaction_id": transaction_id}
            )
            return self._process_query_result(result, "äº¤æ˜“æ¨æ’­è¨˜éŒ„æŸ¥è©¢æˆåŠŸ")
        except Exception as e:
            logger.error(f"æŸ¥è©¢äº¤æ˜“æ¨æ’­è¨˜éŒ„å¤±æ•—: {e}")
            return QueryResult(success=False, message=f"æŸ¥è©¢å¤±æ•—: {str(e)}")
```

### Infrastructure Layer (åŸºç¤è¨­æ–½å±¤) - HTTP é©é…å™¨

```python
class InternalAPIInvokerPort(ABC):
    """Internal API Gateway èª¿ç”¨ç«¯å£æ¥å£"""

    @abstractmethod
    async def invoke_query_api(self, query_type: str, payload: Dict[str, Any]) -> Dict[str, Any]:
        pass

class InternalAPIAdapter(InternalAPIInvokerPort):
    """Internal API Gateway èª¿ç”¨é©é…å™¨ - V4"""

    def __init__(self) -> None:
        self.internal_api_url = os.environ.get(
            "INTERNAL_API_URL",
            "https://internal-api-gateway.amazonaws.com/v1"
        ).rstrip("/")
        self.timeout = int(os.environ.get("REQUEST_TIMEOUT", "5"))

    async def invoke_query_api(self, query_type: str, payload: Dict[str, Any]) -> Dict[str, Any]:
        """èª¿ç”¨ Internal API Gateway æŸ¥è©¢ç«¯é»"""
        endpoint_map = {
            "transaction": "/tx",
            "fail": "/fail",
        }

        if query_type not in endpoint_map:
            raise ValueError(f"Unsupported query type: {query_type}")

        endpoint = endpoint_map[query_type]
        url = f"{self.internal_api_url}{endpoint}"

        async with httpx.AsyncClient(timeout=self.timeout) as client:
            response = await client.get(url, params=payload, headers={
                "Content-Type": "application/json",
                "User-Agent": "ECS-QueryService/1.0"
            })

            if response.status_code == 200:
                return response.json()
            else:
                raise HTTPException(
                    status_code=502,
                    detail=f"Internal API Gateway error: {response.status_code}"
                )
```

### Web Layer (Web å±¤) - ç°¡åŒ–ç«¯é»

```python
# FastAPI è·¯ç”± - V4 ç°¡åŒ–è¨­è¨ˆ
@app.get("/tx")
async def get_transaction_notifications_by_id(
    transaction_id: str = Query(..., min_length=1, description="äº¤æ˜“å”¯ä¸€è­˜åˆ¥ç¢¼"),
    query_service: QueryService = Depends(get_query_service)
) -> QueryResult:
    """æŸ¥è©¢äº¤æ˜“æ¨æ’­è¨˜éŒ„ - GET æ–¹å¼"""
    logger.info(f"æ”¶åˆ°äº¤æ˜“æŸ¥è©¢è«‹æ±‚: transaction_id={transaction_id}")

    try:
        result = await query_service.query_transaction_notifications(transaction_id)
        logger.info(f"äº¤æ˜“æŸ¥è©¢å®Œæˆ: success={result.success}, count={result.total_count}")
        return result
    except Exception as e:
        logger.error(f"äº¤æ˜“æŸ¥è©¢ç•°å¸¸: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/fail")
async def get_failed_notifications(
    transaction_id: Optional[str] = Query(None, min_length=1, description="äº¤æ˜“å”¯ä¸€è­˜åˆ¥ç¢¼ï¼ˆå¯é¸ï¼‰"),
    query_service: QueryService = Depends(get_query_service)
) -> QueryResult:
    """æŸ¥è©¢å¤±æ•—æ¨æ’­è¨˜éŒ„ - GET æ–¹å¼"""
    logger.info(f"æ”¶åˆ°å¤±æ•—æŸ¥è©¢è«‹æ±‚: transaction_id={transaction_id}")

    try:
        result = await query_service.query_failed_notifications(transaction_id)
        logger.info(f"å¤±æ•—æŸ¥è©¢å®Œæˆ: success={result.success}, count={result.total_count}")
        return result
    except Exception as e:
        logger.error(f"å¤±æ•—æŸ¥è©¢ç•°å¸¸: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

## ğŸ“Š V4 æŸ¥è©¢é¡å‹ (ç°¡åŒ–)

### 1. äº¤æ˜“æ¨æ’­è¨˜éŒ„æŸ¥è©¢

- **ç«¯é»**: `GET /tx` æˆ– `POST /query/transaction`
- **ç”¨é€”**: æ ¹æ“š `transaction_id` æŸ¥è©¢è©²äº¤æ˜“çš„æ‰€æœ‰æ¨æ’­è¨˜éŒ„
- **ç´¢å¼•**: ä¸»è¡¨æŸ¥è©¢ (`transaction_id`)

### 2. å¤±æ•—æ¨æ’­è¨˜éŒ„æŸ¥è©¢

- **ç«¯é»**: `GET /fail` æˆ– `POST /query/fail`
- **ç”¨é€”**: æ ¹æ“š `transaction_id` æŸ¥è©¢å¤±æ•—çš„æ¨æ’­è¨˜éŒ„ï¼Œæ”¯æ´ç„¡åƒæ•¸æŸ¥è©¢æ‰€æœ‰å¤±æ•—è¨˜éŒ„
- **ç´¢å¼•**: ä¸»è¡¨æŸ¥è©¢ + Status éæ¿¾

## ğŸ”„ V4 è³‡æ–™æµç¨‹

### å¯«å…¥æµç¨‹ (ä¿æŒä¸è®Š)

1. å‘½ä»¤å¯«å…¥ `command-records` è¡¨
2. DynamoDB Stream è§¸ç™¼ `stream_processor_lambda`
3. Lambda è™•ç†äº‹ä»¶ä¸¦è½‰æ›è³‡æ–™æ ¼å¼
4. åŒæ­¥è³‡æ–™åˆ° `notification-records` è¡¨

### æŸ¥è©¢æµç¨‹ (V4 ç°¡åŒ–)

1. å®¢æˆ¶ç«¯å‘¼å« `/tx` æˆ– `/fail` ç«¯é»
2. FastAPI è·¯ç”±æ¥æ”¶è«‹æ±‚
3. `QueryService` è™•ç†æ¥­å‹™é‚è¼¯
4. `InternalAPIAdapter` å‘¼å« Internal API Gateway
5. æŸ¥è©¢ `notification-records` è¡¨
6. è¿”å›çµ±ä¸€çš„ `QueryResult` æ ¼å¼

## ğŸ­ V4 å„ªå‹¢èˆ‡ç‰¹è‰²

### âœ… ç°¡åŒ–å„ªå‹¢

- **æ¸›å°‘ç«¯é»**: å¾ 3 å€‹æŸ¥è©¢ç«¯é»ç°¡åŒ–ç‚º 2 å€‹æ ¸å¿ƒç«¯é»
- **çµ±ä¸€æ¨¡å‹**: å–®ä¸€ `NotificationRecord` é ˜åŸŸæ¨¡å‹
- **å°ˆæ³¨è·è²¬**: ä»¥ `transaction_id` ç‚ºä¸­å¿ƒçš„æŸ¥è©¢è²¬ä»»
- **æå‡æ•ˆèƒ½**: æ¸›å°‘è¤‡é›œçš„æŸ¥è©¢é‚è¼¯å’Œç´¢å¼•ç¶­è­·

### âœ… æ¶æ§‹å„ªå‹¢

- **ä¿æŒå…­é‚Šå½¢**: ç¶­æŒæ¸…æ™°çš„æ¶æ§‹åˆ†å±¤å’Œä¾è³´åè½‰
- **HTTP æ•´åˆ**: é€é Internal API Gateway çš„å¾®æœå‹™é€šä¿¡
- **ä¾è³´æ³¨å…¥**: FastAPI åŸç”Ÿçš„ä¾è³´æ³¨å…¥ç³»çµ±
- **å¯æ¸¬è©¦æ€§**: Mock å‹å¥½çš„ç«¯å£èˆ‡é©é…å™¨è¨­è¨ˆ

### âœ… é–‹ç™¼é«”é©—

- **æ¸…æ™°æ„åœ–**: GET æ–¹å¼ç›´è§€ï¼ŒPOST æ–¹å¼å®Œæ•´
- **éŒ¯èª¤è™•ç†**: çµ±ä¸€çš„ç•°å¸¸è™•ç†å’Œæ—¥èªŒè¨˜éŒ„
- **API æ–‡æª”**: Pydantic æ¨¡å‹è‡ªå‹•ç”Ÿæˆ OpenAPI è¦ç¯„
- **é¡å‹å®‰å…¨**: å®Œæ•´çš„ Python é¡å‹æç¤º

## ğŸ” V4 èˆ‡å‰ç‰ˆæœ¬å°æ¯”

| ç‰¹æ€§                   | V3 ç‰ˆæœ¬                              | V4 ç‰ˆæœ¬                        |
| ---------------------- | ------------------------------------ | ------------------------------ |
| **æŸ¥è©¢ç«¯é»**           | 3 å€‹ç«¯é» (user/marketing/failures)  | 2 å€‹ç«¯é» (tx/fail)             |
| **é ˜åŸŸæ¨¡å‹**           | 3 å€‹ä¸åŒçš„å›æ‡‰æ¨¡å‹                   | 1 å€‹çµ±ä¸€çš„ NotificationRecord  |
| **æŸ¥è©¢é‚è¼¯**           | è¤‡é›œçš„å¤šç¶­åº¦æŸ¥è©¢                     | ç°¡åŒ–çš„ transaction_id ä¸­å¿ƒæŸ¥è©¢ |
| **HTTP æ–¹æ³•**          | åƒ… POST                              | GET + POST é›™æ”¯æ´              |
| **Architecture**       | EKS ç›´æ¥ Lambda èª¿ç”¨                 | ECS + Internal API Gateway     |
| **è³‡æ–™ç´¢å¼•**           | å¤šå€‹ GSI                             | ä¸»éµæŸ¥è©¢ + ç°¡å–®éæ¿¾            |
| **æ•ˆèƒ½**               | å¤šç´¢å¼•æŸ¥è©¢ï¼Œè¼ƒæ…¢                     | å–®ä¸€ç´¢å¼•ï¼Œé«˜æ•ˆèƒ½               |
| **ç¶­è­·æ€§**             | è¤‡é›œçš„æ¥­å‹™é‚è¼¯                       | ç°¡åŒ–çš„è²¬ä»»åˆ†é›¢                 |

## ğŸ§ª V4 æ¸¬è©¦ç­–ç•¥

### å–®å…ƒæ¸¬è©¦

```python
class TestQueryServiceV4:
    """V4 æŸ¥è©¢æœå‹™å–®å…ƒæ¸¬è©¦"""

    @pytest.mark.asyncio
    async def test_query_transaction_notifications(self):
        # æ¸¬è©¦äº¤æ˜“æŸ¥è©¢åŠŸèƒ½

    @pytest.mark.asyncio
    async def test_query_failed_notifications(self):
        # æ¸¬è©¦å¤±æ•—æŸ¥è©¢åŠŸèƒ½

    @pytest.mark.asyncio
    async def test_internal_api_adapter(self):
        # æ¸¬è©¦ Internal API é©é…å™¨
```

### æ•´åˆæ¸¬è©¦

```python
class TestV4Integration:
    """V4 æ•´åˆæ¸¬è©¦"""

    @pytest.mark.asyncio
    async def test_end_to_end_transaction_query(self):
        # ç«¯åˆ°ç«¯äº¤æ˜“æŸ¥è©¢æ¸¬è©¦

    @pytest.mark.asyncio
    async def test_end_to_end_fail_query(self):
        # ç«¯åˆ°ç«¯å¤±æ•—æŸ¥è©¢æ¸¬è©¦
```

## ğŸš€ V4 éƒ¨ç½²è€ƒé‡

### ç’°å¢ƒè®Šæ•¸

```bash
# V4 å°ˆç”¨ç’°å¢ƒè®Šæ•¸
INTERNAL_API_URL=https://internal-api-gateway.amazonaws.com/v1
REQUEST_TIMEOUT=5
ENVIRONMENT=production
```

### ç›£æ§æŒ‡æ¨™

- **ç«¯é»éŸ¿æ‡‰æ™‚é–“**: `/tx` å’Œ `/fail` ç«¯é»çš„å›æ‡‰æ™‚é–“
- **æˆåŠŸç‡**: `QueryResult.success` çš„ç™¾åˆ†æ¯”
- **éŒ¯èª¤åˆ†å¸ƒ**: HTTP ç‹€æ…‹ç¢¼å’ŒéŒ¯èª¤é¡å‹åˆ†æ

---

**V4 ç‰ˆæœ¬é€éç°¡åŒ–è¨­è¨ˆå¯¦ç¾äº†æ›´é«˜çš„æ•ˆèƒ½å’Œå¯ç¶­è­·æ€§ï¼ŒåŒæ™‚ä¿æŒäº†å…­é‚Šå½¢æ¶æ§‹çš„æ ¸å¿ƒåŸå‰‡ã€‚** ğŸ¯
