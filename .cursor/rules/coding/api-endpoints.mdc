---
description:
globs:
alwaysApply: false
---
# API ç«¯é»æŒ‡å—

## ğŸŒ FastAPI æœå‹™ API ç«¯é»

æœ¬å°ˆæ¡ˆçš„ FastAPI æœå‹™ ([main.py](mdc:query-service/eks_handler/main.py)) æä¾›å®Œæ•´çš„ RESTful APIï¼Œæ”¯æ´æ¨æ’­é€šçŸ¥æŸ¥è©¢åŠŸèƒ½ã€‚

### ğŸ“‹ API æ–‡æª”å­˜å–
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **OpenAPI JSON**: http://localhost:8000/openapi.json

## ğŸ¯ æ ¸å¿ƒæŸ¥è©¢ç«¯é»

### 1. å¥åº·æª¢æŸ¥
```http
GET /health
```
**åŠŸèƒ½**: æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹
**å›æ‡‰**:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00Z",
  "version": "4.2.0"
}
```

### 2. äº¤æ˜“æ¨æ’­æŸ¥è©¢

#### GET æ–¹å¼ (æ¨è–¦)
```http
GET /tx?transaction_id={id}&limit={number}
```
**åƒæ•¸**:
- `transaction_id` (å¯é¸): äº¤æ˜“å”¯ä¸€è­˜åˆ¥ç¢¼
- `limit` (å¯é¸): æŸ¥è©¢ç­†æ•¸é™åˆ¶ (1-100ï¼Œé è¨­30)

**ç¯„ä¾‹**:
```bash
# æŸ¥è©¢ç‰¹å®šäº¤æ˜“
curl "http://localhost:8000/tx?transaction_id=tx_001"

# æŸ¥è©¢å¤šç­†è¨˜éŒ„
curl "http://localhost:8000/tx?limit=50"

# æŸ¥è©¢æ‰€æœ‰è¨˜éŒ„
curl "http://localhost:8000/tx"
```

#### POST æ–¹å¼ (å·²æ£„ç”¨)
```http
POST /query/transaction
Content-Type: application/json

{
  "transaction_id": "tx_001"
}
```

### 3. å¤±æ•—æ¨æ’­æŸ¥è©¢

#### GET æ–¹å¼ (æ¨è–¦)
```http
GET /fail?transaction_id={id}
```
**åƒæ•¸**:
- `transaction_id` (å¯é¸): äº¤æ˜“å”¯ä¸€è­˜åˆ¥ç¢¼

**ç¯„ä¾‹**:
```bash
# æŸ¥è©¢ç‰¹å®šå¤±æ•—è¨˜éŒ„
curl "http://localhost:8000/fail?transaction_id=tx_002"

# æŸ¥è©¢æ‰€æœ‰å¤±æ•—è¨˜éŒ„
curl "http://localhost:8000/fail"
```

#### POST æ–¹å¼
```http
POST /query/fail
Content-Type: application/json

{
  "transaction_id": "tx_002"
}
```

### 4. SNS æ¨æ’­æŸ¥è©¢

#### GET æ–¹å¼ (æ¨è–¦)
```http
GET /sns?sns_id={id}
```
**åƒæ•¸**:
- `sns_id` (å¿…å¡«): SNS æ¨æ’­è­˜åˆ¥ç¢¼

**ç¯„ä¾‹**:
```bash
curl "http://localhost:8000/sns?sns_id=sns-12345"
```

#### POST æ–¹å¼
```http
POST /query/sns
Content-Type: application/json

{
  "sns_id": "sns-12345"
}
```

### 5. æ ¹ç«¯é»
```http
GET /
```
**åŠŸèƒ½**: API æœå‹™è³‡è¨Šèˆ‡å¯ç”¨ç«¯é»åˆ—è¡¨

## ğŸ“Š çµ±ä¸€å›æ‡‰æ ¼å¼

æ‰€æœ‰æŸ¥è©¢ç«¯é»éƒ½è¿”å›çµ±ä¸€çš„ `QueryResult` æ ¼å¼ï¼š

```json
{
  "success": true,
  "data": [
    {
      "transaction_id": "tx_001",
      "token": "device_token_123",
      "platform": "IOS",
      "notification_title": "æ¸¬è©¦æ¨æ’­",
      "notification_body": "é€™æ˜¯æ¸¬è©¦è¨Šæ¯",
      "status": "delivered",
      "send_ts": 1640995200000,
      "delivered_ts": 1640995260000,
      "failed_ts": null,
      "ap_id": "app_001",
      "created_at": 1640995200000,
      "sns_id": "sns-12345",
      "retry_cnt": 0,
      "send_time_utc8": "2022-01-01 12:00:00 UTC+8",
      "delivered_time_utc8": "2022-01-01 12:01:00 UTC+8",
      "failed_time_utc8": null,
      "created_time_utc8": "2022-01-01 12:00:00 UTC+8"
    }
  ],
  "message": "æŸ¥è©¢æˆåŠŸ",
  "total_count": 1,
  "query_info": {
    "query_type": "transaction",
    "transaction_id": "tx_001",
    "limit": 30
  }
}
```

## ğŸ” æŸ¥è©¢åƒæ•¸èªªæ˜

### æ¨æ’­å¹³å°é¡å‹
- `IOS`: iOS è£ç½®
- `ANDROID`: Android è£ç½®
- `WEBPUSH`: ç¶²é æ¨æ’­

### æ¨æ’­ç‹€æ…‹
- `sent`: å·²é€å‡º
- `delivered`: å·²é€é”
- `failed`: é€é”å¤±æ•—
- `pending`: ç­‰å¾…è™•ç†

## ğŸ› ï¸ API æ¸¬è©¦å·¥å…·

### å…§å»ºæ¸¬è©¦è…³æœ¬
```bash
# ä½¿ç”¨å°ˆæ¡ˆæŸ¥è©¢å·¥å…·
./scripts/queries/test_query.sh

# ç°¡åŒ–æŸ¥è©¢å·¥å…·
./scripts/queries/simple_query.sh --all
```

### cURL ç¯„ä¾‹
```bash
# å¥åº·æª¢æŸ¥
curl -X GET "http://localhost:8000/health"

# æŸ¥è©¢äº¤æ˜“æ¨æ’­
curl -X GET "http://localhost:8000/tx?transaction_id=tx_001&limit=10"

# æŸ¥è©¢å¤±æ•—è¨˜éŒ„
curl -X GET "http://localhost:8000/fail?transaction_id=tx_002"

# æŸ¥è©¢ SNS æ¨æ’­
curl -X GET "http://localhost:8000/sns?sns_id=sns-12345"

# POST æ–¹å¼æŸ¥è©¢
curl -X POST "http://localhost:8000/query/transaction" \
  -H "Content-Type: application/json" \
  -d '{"transaction_id": "tx_001"}'
```

### Python å®¢æˆ¶ç«¯ç¯„ä¾‹
```python
import httpx

async def test_api():
    async with httpx.AsyncClient() as client:
        # å¥åº·æª¢æŸ¥
        response = await client.get("http://localhost:8000/health")
        print(response.json())

        # æŸ¥è©¢äº¤æ˜“
        response = await client.get(
            "http://localhost:8000/tx",
            params={"transaction_id": "tx_001"}
        )
        print(response.json())
```

## âš ï¸ éŒ¯èª¤è™•ç†

### HTTP ç‹€æ…‹ç¢¼
- `200`: æˆåŠŸ
- `400`: è«‹æ±‚åƒæ•¸éŒ¯èª¤
- `422`: è«‹æ±‚è³‡æ–™é©—è­‰å¤±æ•—
- `500`: ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤

### éŒ¯èª¤å›æ‡‰æ ¼å¼
```json
{
  "success": false,
  "data": [],
  "message": "æŸ¥è©¢å¤±æ•—: transaction_id ä¸èƒ½ç‚ºç©º",
  "total_count": 0,
  "query_info": null
}
```

### é©—è­‰éŒ¯èª¤ç¯„ä¾‹
```json
{
  "detail": [
    {
      "loc": ["query", "transaction_id"],
      "msg": "ensure this value has at least 1 characters",
      "type": "value_error.any_str.min_length",
      "ctx": {"limit_value": 1}
    }
  ]
}
```

## ğŸš€ æ•ˆèƒ½èˆ‡æœ€ä½³åŒ–

### æŸ¥è©¢é™åˆ¶
- **æœ€å¤§ç­†æ•¸**: 100 ç­†/æ¬¡
- **é è¨­ç­†æ•¸**: 30 ç­†
- **è«‹æ±‚è¶…æ™‚**: 5 ç§’

### å¿«å–ç­–ç•¥
- å…§éƒ¨ API å‘¼å«æœ‰ 5 ç§’è¶…æ™‚
- æ”¯æ´æœ¬åœ°é–‹ç™¼ç’°å¢ƒå¿«é€Ÿå›æ‡‰

### ç›£æ§æŒ‡æ¨™
- API å›æ‡‰æ™‚é–“
- æŸ¥è©¢æˆåŠŸç‡
- éŒ¯èª¤åˆ†å¸ƒçµ±è¨ˆ

## ğŸ”’ å®‰å…¨æ€§

### è¼¸å…¥é©—è­‰
- æ‰€æœ‰åƒæ•¸éƒ½ç¶“é Pydantic é©—è­‰
- SQL Injection é˜²è­·
- åƒæ•¸é•·åº¦é™åˆ¶

### éŒ¯èª¤è¨Šæ¯
- ä¸æ´©éœ²æ•æ„Ÿç³»çµ±è³‡è¨Š
- æä¾›å‹å–„çš„éŒ¯èª¤èªªæ˜
- è©³ç´°æ—¥èªŒè¨˜éŒ„ (ä¸åŒ…å«åœ¨å›æ‡‰ä¸­)

## ğŸ“ˆ ç‰ˆæœ¬æ¼”é€²

### V4 ç‰ˆæœ¬ç‰¹è‰²
- å°ˆæ³¨æ–¼ `transaction_id` åŸºç¤æŸ¥è©¢
- çµ±ä¸€çš„æŸ¥è©¢çµæœæ¨¡å‹
- UTC+8 æ™‚å€è‡ªå‹•è½‰æ›
- æ”¹é€²çš„éŒ¯èª¤è™•ç†

### V4.1 æ–°å¢åŠŸèƒ½
- SNS æŸ¥è©¢ç«¯é»
- å¢å¼·çš„æŸ¥è©¢è³‡è¨Š
- æ›´å¥½çš„ API æ–‡æª”
