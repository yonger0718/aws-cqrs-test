---
description:
globs:
alwaysApply: false
---
# AWS æœå‹™æ•´åˆæŒ‡å—

## â˜ï¸ ä½¿ç”¨çš„ AWS æœå‹™

æœ¬å°ˆæ¡ˆæ•´åˆå¤šå€‹ AWS æœå‹™å¯¦ç¾ CQRS æ¶æ§‹ï¼Œä¸¦ä½¿ç”¨ LocalStack é€²è¡Œæœ¬åœ°é–‹ç™¼ã€‚

### æ ¸å¿ƒ AWS æœå‹™

#### ğŸ—„ï¸ DynamoDB
- **Command Side è¡¨æ ¼**: `command-records`
  - è™•ç†å¯«å…¥æ“ä½œ
  - è§¸ç™¼ DynamoDB Stream äº‹ä»¶

- **Query Side è¡¨æ ¼**: `notification-records`
  - æœ€ä½³åŒ–æŸ¥è©¢æ•ˆèƒ½
  - æ”¯æ´ GSI (Global Secondary Index)

#### âš¡ Lambda Functions
- **Stream Processor**: [stream_processor_lambda/](mdc:query-service/lambdas/stream_processor_lambda)
  - è™•ç† DynamoDB Stream äº‹ä»¶
  - è‡ªå‹•åŒæ­¥ Command Side åˆ° Query Side

- **Query Lambda**: [query_lambda/](mdc:query-service/lambdas/query_lambda)
  - è™•ç†æŸ¥è©¢è«‹æ±‚
  - èˆ‡ API Gateway æ•´åˆ

- **Query Result Lambda**: [query_result_lambda/](mdc:query-service/lambdas/query_result_lambda)
  - è™•ç†æŸ¥è©¢çµæœ
  - è³‡æ–™è½‰æ›èˆ‡æ ¼å¼åŒ–

#### ğŸŒ API Gateway
- **RESTful API ç«¯é»**
- **Lambda å‡½æ•¸è§¸ç™¼å™¨**
- **è«‹æ±‚/å›æ‡‰è½‰æ›**
- **é…ç½®æª”æ¡ˆ**: [api-gateway/](mdc:query-service/infra/api-gateway)

#### ğŸ“¬ SNS (Simple Notification Service)
- **æ¨æ’­é€šçŸ¥æœå‹™**
- **èˆ‡ Lambda å‡½æ•¸æ•´åˆ**
- **æ”¯æ´ iOSã€Androidã€WebPush**

#### ğŸ¯ ECS (Elastic Container Service)
- **å®¹å™¨åŒ–éƒ¨ç½²**
- **FastAPI æœå‹™é‹è¡Œç’°å¢ƒ**
- **é…ç½®**: [ecs/](mdc:query-service/infra/ecs)

## ğŸ”„ æœå‹™æ•´åˆæ¨¡å¼

### CQRS è³‡æ–™æµ
```txt
1. å¯«å…¥è«‹æ±‚ â†’ Command Side (DynamoDB)
2. DynamoDB Stream â†’ Stream Processor Lambda
3. è³‡æ–™è½‰æ› â†’ Query Side (DynamoDB)
4. æŸ¥è©¢è«‹æ±‚ â†’ Query Lambda
5. çµæœå›å‚³ â†’ FastAPI Service
```

### API Gateway æ•´åˆ
```txt
Client Request â†’ API Gateway â†’ Lambda Function â†’ DynamoDB â†’ Response
```

### ECS æœå‹™æ•´åˆ
```txt
ECS Task â†’ FastAPI App â†’ Internal API Gateway â†’ Lambda Functions
```

## ğŸ› ï¸ LocalStack æœ¬åœ°é–‹ç™¼

### æ”¯æ´çš„æœå‹™
- **DynamoDB**: æœ¬åœ°è³‡æ–™åº«æ¨¡æ“¬
- **Lambda**: å‡½æ•¸åŸ·è¡Œç’°å¢ƒ
- **API Gateway**: API ç«¯é»æ¨¡æ“¬
- **SNS**: æ¨æ’­æœå‹™æ¨¡æ“¬
- **CloudWatch**: æ—¥èªŒèˆ‡ç›£æ§

### é…ç½®æª”æ¡ˆ
- **Docker Compose**: [docker-compose.yml](mdc:query-service/docker-compose.yml)
- **LocalStack é…ç½®**: [infra/localstack/](mdc:query-service/infra/localstack)

## ğŸ”§ AWS é…ç½®èˆ‡ç®¡ç†

### ç’°å¢ƒè®Šæ•¸
```bash
# AWS å€åŸŸ
AWS_DEFAULT_REGION=ap-southeast-1

# LocalStack ç«¯é»
LOCALSTACK_ENDPOINT=http://localhost:4566

# API Gateway URL
INTERNAL_API_URL=https://internal-api-gateway.amazonaws.com/v1
```

### æœå‹™åˆå§‹åŒ–
```bash
# å•Ÿå‹• LocalStack æœå‹™
cd query-service
./deploy_docker.sh start

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker ps | grep localstack

# é©—è­‰ AWS æœå‹™
awslocal dynamodb list-tables
awslocal lambda list-functions
```

## ğŸ“Š DynamoDB è³‡æ–™æ¨¡å‹

### Command Records è¡¨æ ¼
```json
{
  "transaction_id": "tx_001",
  "token": "device_token_123",
  "platform": "IOS",
  "notification_title": "æ¸¬è©¦æ¨æ’­",
  "notification_body": "é€™æ˜¯æ¸¬è©¦è¨Šæ¯",
  "status": "sent",
  "send_ts": 1640995200000,
  "ap_id": "app_001",
  "created_at": 1640995200000
}
```

### Notification Records è¡¨æ ¼
```json
{
  "transaction_id": "tx_001",
  "token": "device_token_123",
  "platform": "IOS",
  "notification_title": "æ¸¬è©¦æ¨æ’­",
  "notification_body": "é€™æ˜¯æ¸¬è©¦è¨Šæ¯",
  "status": "delivered",
  "send_ts": 1640995200000,
  "delivered_ts": 1640995260000,
  "sns_id": "sns-12345",
  "retry_cnt": 0,
  "created_at": 1640995200000
}
```

## âš¡ Lambda å‡½æ•¸é–‹ç™¼

### å‡½æ•¸çµæ§‹
```python
# Lambda è™•ç†å™¨ç¯„ä¾‹
def lambda_handler(event, context):
    try:
        # è™•ç†äº‹ä»¶
        process_event(event)

        return {
            'statusCode': 200,
            'body': json.dumps({'success': True})
        }
    except Exception as e:
        logger.error(f"Lambda error: {e}")
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }
```

### éƒ¨ç½²èˆ‡æ¸¬è©¦
```bash
# éƒ¨ç½² Lambda å‡½æ•¸
cd query-service
./deploy_docker.sh deploy

# æ¸¬è©¦ Lambda å‡½æ•¸
python test_lambda.py

# æŸ¥çœ‹ Lambda æ—¥èªŒ
docker logs query-service-query-lambda-1
```

## ğŸ” ç›£æ§èˆ‡é™¤éŒ¯

### CloudWatch æ—¥èªŒ
```bash
# æŸ¥çœ‹æœ¬åœ° CloudWatch æ—¥èªŒ
awslocal logs describe-log-groups
awslocal logs get-log-events --log-group-name /aws/lambda/query-lambda
```

### DynamoDB æ“ä½œ
```bash
# åˆ—å‡ºæ‰€æœ‰è¡¨æ ¼
awslocal dynamodb list-tables

# æŸ¥è©¢è¡¨æ ¼å…§å®¹
awslocal dynamodb scan --table-name notification-records

# æŸ¥è©¢ç‰¹å®šé …ç›®
awslocal dynamodb get-item --table-name notification-records --key '{"transaction_id":{"S":"tx_001"}}'
```

### API Gateway æ¸¬è©¦
```bash
# æ¸¬è©¦ API ç«¯é»
curl "http://localhost:4566/restapis/{api-id}/test/_user_request_/tx?transaction_id=tx_001"

# ä¿®å¾© API Gateway é…ç½®
./scripts/infrastructure/fix_api_gateway.sh
```

## ğŸš€ éƒ¨ç½²ç­–ç•¥

### æœ¬åœ°é–‹ç™¼
1. ä½¿ç”¨ LocalStack æ¨¡æ“¬ AWS æœå‹™
2. Docker Compose ä¸€éµå•Ÿå‹•ç’°å¢ƒ
3. å¿«é€Ÿæ¸¬è©¦èˆ‡è¿­ä»£

### ç”Ÿç”¢éƒ¨ç½²
1. **Infrastructure as Code** (å°‡ä¾†å¯ä½¿ç”¨ CDK/Terraform)
2. **å®¹å™¨åŒ–éƒ¨ç½²** (ECS/Fargate)
3. **ç›£æ§èˆ‡å‘Šè­¦** (CloudWatch)

### ç’°å¢ƒç®¡ç†
```bash
# é–‹ç™¼ç’°å¢ƒ
ENVIRONMENT=development

# æ¸¬è©¦ç’°å¢ƒ
ENVIRONMENT=test

# ç”Ÿç”¢ç’°å¢ƒ
ENVIRONMENT=production
```

## ğŸ”’ å®‰å…¨æ€§è€ƒé‡

### IAM æ¬Šé™
- Lambda åŸ·è¡Œè§’è‰²æœ€å°æ¬Šé™åŸå‰‡
- DynamoDB å­˜å–æ¬Šé™æ§åˆ¶
- API Gateway èªè­‰æˆæ¬Š

### è³‡æ–™ä¿è­·
- æ•æ„Ÿè³‡æ–™åŠ å¯†
- ç¶²è·¯å®‰å…¨ç¾¤çµ„è¨­å®š
- VPC éš”é›¢ (å¦‚é©ç”¨)

### ç›£æ§å‘Šè­¦
- ç•°å¸¸å­˜å–ç›£æ§
- æ•ˆèƒ½æŒ‡æ¨™è¿½è¹¤
- éŒ¯èª¤ç‡å‘Šè­¦
