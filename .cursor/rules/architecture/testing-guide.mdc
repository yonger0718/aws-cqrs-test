---
description:
globs:
alwaysApply: false
---
# æ¸¬è©¦æŒ‡å—

## ğŸ§ª æ¸¬è©¦æ¡†æ¶æ¦‚è¦½

æœ¬å°ˆæ¡ˆä½¿ç”¨ **pytest** ä½œç‚ºä¸»è¦æ¸¬è©¦æ¡†æ¶ï¼Œé…åˆå¤šç¨®æ¸¬è©¦å·¥å…·å¯¦ç¾å®Œæ•´çš„æ¸¬è©¦è¦†è“‹ã€‚

### æ¸¬è©¦æ¶æ§‹
- **æ¸¬è©¦æ¡†æ¶**: pytest + pytest-asyncio
- **è¦†è“‹ç‡å·¥å…·**: pytest-cov
- **Mock æ¡†æ¶**: unittest.mock + moto (AWS æœå‹™æ¨¡æ“¬)
- **HTTP å®¢æˆ¶ç«¯**: httpx (ç”¨æ–¼ API æ¸¬è©¦)

## ğŸ“ æ¸¬è©¦æª”æ¡ˆçµæ§‹

### ä¸»è¦æ¸¬è©¦æª”æ¡ˆ
- **[test_eks_handler.py](mdc:query-service/tests/test_eks_handler.py)** - FastAPI æœå‹™æ¸¬è©¦
- **[test_integration.py](mdc:query-service/tests/test_integration.py)** - æ•´åˆæ¸¬è©¦
- **[conftest.py](mdc:query-service/tests/conftest.py)** - æ¸¬è©¦é…ç½®èˆ‡ fixtures
- **[test_lambdas/](mdc:query-service/tests/test_lambdas)** - Lambda å‡½æ•¸æ¸¬è©¦

### æ¸¬è©¦é…ç½®æª”æ¡ˆ
- **[pyproject.toml](mdc:pyproject.toml)** - pytest é…ç½®ã€è¦†è“‹ç‡è¨­å®š
- **[requirements-test.txt](mdc:query-service/tests/requirements-test.txt)** - æ¸¬è©¦å°ˆç”¨ä¾è³´

## ğŸ¯ æ¸¬è©¦é¡å‹èˆ‡åŸ·è¡Œ

### 1. å–®å…ƒæ¸¬è©¦ (Unit Tests)
```bash
# åŸ·è¡Œæ‰€æœ‰å–®å…ƒæ¸¬è©¦
poetry run pytest -m unit

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦æª”æ¡ˆ
poetry run pytest query-service/tests/test_eks_handler.py -v

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦å‡½æ•¸
poetry run pytest query-service/tests/test_eks_handler.py::test_health_check -v
```

### 2. æ•´åˆæ¸¬è©¦ (Integration Tests)
```bash
# åŸ·è¡Œæ•´åˆæ¸¬è©¦
poetry run pytest -m integration

# åŸ·è¡Œ API æ•´åˆæ¸¬è©¦
poetry run pytest query-service/tests/test_integration.py -v
```

### 3. è¦†è“‹ç‡æ¸¬è©¦
```bash
# ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
poetry run pytest --cov=query-service/eks_handler --cov-report=html

# æª¢è¦– HTML è¦†è“‹ç‡å ±å‘Š
open htmlcov/index.html

# çµ‚ç«¯é¡¯ç¤ºè¦†è“‹ç‡
poetry run pytest --cov=query-service/eks_handler --cov-report=term-missing
```

### 4. å®Œæ•´æ¸¬è©¦å¥—ä»¶
```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
poetry run pytest

# å¿«é€Ÿæ¸¬è©¦ (æ’é™¤æ…¢é€Ÿæ¸¬è©¦)
poetry run pytest -m "not slow"

# ä¸¦è¡Œæ¸¬è©¦ (åŠ é€ŸåŸ·è¡Œ)
poetry run pytest -n auto
```

## ğŸ› ï¸ æ¸¬è©¦å·¥å…·èˆ‡è…³æœ¬

### è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬
```bash
# å¿«é€Ÿç³»çµ±é©—è­‰
./scripts/testing/quick_test.sh

# å®Œæ•´æµç¨‹æ¸¬è©¦
./scripts/testing/test_full_flow.sh

# Lambda å‡½æ•¸æ¸¬è©¦
./scripts/testing/test_lambda_deployment.sh
```

### å°ˆæ¡ˆç‰¹å®šæ¸¬è©¦å·¥å…·
```bash
# EKS Handler æ¸¬è©¦
python query-service/test_ecs_architecture.py

# Lambda æ¸¬è©¦
python query-service/test_lambda.py

# é©—è­‰æ”¹é€²
python query-service/validate_improvements.py
```

## ğŸ“‹ æ¸¬è©¦ Markers

### å¯ç”¨çš„æ¸¬è©¦æ¨™è¨˜
```python
@pytest.mark.unit          # å–®å…ƒæ¸¬è©¦
@pytest.mark.integration   # æ•´åˆæ¸¬è©¦
@pytest.mark.slow          # æ…¢é€Ÿæ¸¬è©¦
```

### ä½¿ç”¨ç¯„ä¾‹
```bash
# åªåŸ·è¡Œå–®å…ƒæ¸¬è©¦
pytest -m unit

# æ’é™¤æ…¢é€Ÿæ¸¬è©¦
pytest -m "not slow"

# åŸ·è¡Œæ•´åˆæ¸¬è©¦
pytest -m integration
```

## ğŸ”§ æ¸¬è©¦é…ç½®é‡é»

### pytest é…ç½® ([pyproject.toml](mdc:pyproject.toml))
```toml
[tool.pytest.ini_options]
testpaths = ["query-service/tests"]
asyncio_mode = "auto"
addopts = [
    "--strict-markers",
    "--cov=query-service/eks_handler",
    "--cov-fail-under=60"
]
```

### è¦†è“‹ç‡é…ç½®
```toml
[tool.coverage.run]
source = ["query-service/eks_handler"]
omit = ["*/tests/*", "*/__pycache__/*"]

[tool.coverage.report]
exclude_lines = ["pragma: no cover", "@abstractmethod"]
```

## ğŸ¯ æ¸¬è©¦æœ€ä½³å¯¦è¸

### 1. æ¸¬è©¦çµæ§‹
```python
# AAA æ¨¡å¼: Arrange, Act, Assert
async def test_query_transaction():
    # Arrange - æº–å‚™æ¸¬è©¦è³‡æ–™
    transaction_id = "tx_001"

    # Act - åŸ·è¡Œæ¸¬è©¦å‹•ä½œ
    result = await query_service.query_transaction(transaction_id)

    # Assert - é©—è­‰çµæœ
    assert result.success is True
    assert len(result.data) > 0
```

### 2. Fixtures ä½¿ç”¨
```python
# ä½¿ç”¨å…±ç”¨ fixtures ([conftest.py](mdc:query-service/tests/conftest.py))
async def test_api_endpoint(client, mock_lambda_adapter):
    response = await client.get("/tx?transaction_id=tx_001")
    assert response.status_code == 200
```

### 3. Mock ç­–ç•¥
```python
# Mock å¤–éƒ¨ä¾è³´
@patch('eks_handler.main.InternalAPIAdapter')
async def test_with_mocked_adapter(mock_adapter):
    mock_adapter.return_value.invoke_transaction_query.return_value = {...}
    # æ¸¬è©¦é‚è¼¯
```

### 4. ç•°æ­¥æ¸¬è©¦
```python
# ä½¿ç”¨ pytest-asyncio è™•ç†ç•°æ­¥å‡½æ•¸
@pytest.mark.asyncio
async def test_async_function():
    result = await some_async_function()
    assert result is not None
```

## ğŸ› å¸¸è¦‹æ¸¬è©¦å ´æ™¯

### API ç«¯é»æ¸¬è©¦
```python
async def test_health_check_endpoint(client):
    """æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»"""
    response = await client.get("/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"
```

### æœå‹™å±¤æ¸¬è©¦
```python
async def test_query_service_logic(mock_adapter):
    """æ¸¬è©¦æŸ¥è©¢æœå‹™é‚è¼¯"""
    query_service = QueryService(mock_adapter)
    result = await query_service.query_transaction_notifications("tx_001")
    assert result.success is True
```

### éŒ¯èª¤è™•ç†æ¸¬è©¦
```python
async def test_error_handling(client):
    """æ¸¬è©¦éŒ¯èª¤è™•ç†"""
    response = await client.get("/tx?transaction_id=")
    assert response.status_code == 422  # Validation error
```

### Lambda å‡½æ•¸æ¸¬è©¦
```python
def test_lambda_handler(lambda_event):
    """æ¸¬è©¦ Lambda å‡½æ•¸è™•ç†å™¨"""
    result = lambda_handler(lambda_event, None)
    assert result["statusCode"] == 200
```

## ğŸ“Š æ¸¬è©¦å ±å‘Šèˆ‡åˆ†æ

### è¦†è“‹ç‡å ±å‘Š
- **HTML å ±å‘Š**: `htmlcov/index.html`
- **XML å ±å‘Š**: `coverage.xml` (ç”¨æ–¼ CI/CD)
- **çµ‚ç«¯å ±å‘Š**: åŸ·è¡Œæ™‚é¡¯ç¤º

### æ¸¬è©¦çµæœåˆ†æ
```bash
# è©³ç´°æ¸¬è©¦å ±å‘Š
pytest --tb=long -v

# å¤±æ•—æ¸¬è©¦é™¤éŒ¯
pytest --lf --tb=short  # åªé‡è·‘å¤±æ•—çš„æ¸¬è©¦

# æ•ˆèƒ½åˆ†æ
pytest --durations=10  # é¡¯ç¤ºæœ€æ…¢çš„ 10 å€‹æ¸¬è©¦
```

## ğŸš€ CI/CD æ•´åˆ

### GitHub Actions
- è‡ªå‹•åŸ·è¡Œæ¸¬è©¦å¥—ä»¶
- ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
- ä¸Šå‚³åˆ° Codecov

### Pre-commit Hooks
- æ¸¬è©¦åŸ·è¡Œæª¢æŸ¥
- ç¨‹å¼ç¢¼å“è³ªé©—è­‰
- è‡ªå‹•æ ¼å¼åŒ–

### æ¸¬è©¦é–¾å€¼
- **æœ€å°è¦†è“‹ç‡**: 60%
- **æ¸¬è©¦å¿…é ˆé€šé**: æ‰€æœ‰æ¸¬è©¦
- **ç¨‹å¼ç¢¼å“è³ª**: ç¬¦åˆ flake8ã€mypy æ¨™æº–
