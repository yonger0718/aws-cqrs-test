---
description:
globs:
alwaysApply: false
---
# AWS CQRS + å…­é‚Šå½¢æ¶æ§‹é€šçŸ¥ç³»çµ± - æ¶æ§‹æ¦‚è¦½

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

æœ¬å°ˆæ¡ˆå¯¦ç¾äº† **CQRS (Command Query Responsibility Segregation)** æ¨¡å¼çµåˆ **å…­é‚Šå½¢æ¶æ§‹ (Hexagonal Architecture)**ï¼Œæä¾›ä¼æ¥­ç´šçš„æ¨æ’­é€šçŸ¥ç³»çµ±ã€‚

### CQRS æ¶æ§‹æ¨¡å¼

```txt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Command Side  â”‚â”€â”€â”€â–¶â”‚  DynamoDB    â”‚â”€â”€â”€â–¶â”‚   Query Side    â”‚
â”‚   (Write Path)  â”‚    â”‚   Stream     â”‚    â”‚   (Read Path)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                      â”‚
         â–¼                      â–¼                      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ command-    â”‚      â”‚   Stream    â”‚      â”‚notification-â”‚
  â”‚ records     â”‚      â”‚ Processor   â”‚      â”‚ records     â”‚
  â”‚ (Write DB)  â”‚      â”‚  Lambda     â”‚      â”‚ (Read DB)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Command Side**: è™•ç†å¯«å…¥æ“ä½œå’Œå‘½ä»¤ï¼Œä½¿ç”¨ `command-records` è³‡æ–™è¡¨
- **Query Side**: æœ€ä½³åŒ–çš„æŸ¥è©¢æ“ä½œï¼Œä½¿ç”¨ `notification-records` è³‡æ–™è¡¨
- **äº‹ä»¶é©…å‹•åŒæ­¥**: DynamoDB Stream è§¸ç™¼çš„ Lambda å‡½æ•¸è‡ªå‹•åŒæ­¥è³‡æ–™

### å…­é‚Šå½¢æ¶æ§‹å±¤æ¬¡

**FastAPI Query Service** æ¡ç”¨å…­é‚Šå½¢æ¶æ§‹ï¼š

1. **Web Layer** ([main.py](mdc:query-service/eks_handler/main.py))
   - FastAPI è·¯ç”±å’Œç«¯é»
   - è«‹æ±‚/å›æ‡‰æ¨¡å‹é©—è­‰
   - API æ–‡æª”è‡ªå‹•ç”Ÿæˆ

2. **Application Layer**
   - æ¥­å‹™ç”¨ä¾‹å¯¦ç¾
   - ä¾è³´æ³¨å…¥ç®¡ç†
   - æŸ¥è©¢æœå‹™å”èª¿

3. **Domain Layer**
   - `NotificationRecord` é ˜åŸŸæ¨¡å‹
   - `QueryResult` æŸ¥è©¢çµæœæ¨¡å‹
   - æ¥­å‹™é‚è¼¯èˆ‡è¦å‰‡

4. **Infrastructure Layer**
   - Lambda é©é…å™¨
   - External API æ•´åˆ
   - ç«¯å£èˆ‡é©é…å™¨æ¨¡å¼

## ğŸ¯ æ ¸å¿ƒçµ„ä»¶

### ä¸»è¦æœå‹™
- **FastAPI æœå‹™**: [query-service/eks_handler/](mdc:query-service/eks_handler) - EKS ä¸Šé‹è¡Œçš„æŸ¥è©¢æœå‹™
- **Lambda å‡½æ•¸**: [query-service/lambdas/](mdc:query-service/lambdas) - äº‹ä»¶è™•ç†å’Œè³‡æ–™åŒæ­¥
- **åŸºç¤è¨­æ–½**: [query-service/infra/](mdc:query-service/infra) - AWS è³‡æºé…ç½®

### æŸ¥è©¢é¡å‹
1. **äº¤æ˜“æŸ¥è©¢**: æ ¹æ“š `transaction_id` æŸ¥è©¢æ¨æ’­è¨˜éŒ„
2. **å¤±æ•—æŸ¥è©¢**: æ ¹æ“š `transaction_id` æŸ¥è©¢å¤±æ•—è¨˜éŒ„
3. **SNS æŸ¥è©¢**: æ ¹æ“š `sns_id` æŸ¥è©¢ SNS æ¨æ’­è¨˜éŒ„

## ğŸ”§ æŠ€è¡“å †ç–Š

- **Python 3.12** + **Poetry** ä¾è³´ç®¡ç†
- **FastAPI** + **Pydantic** Web æ¡†æ¶
- **AWS Lambda** + **DynamoDB** é›²ç«¯æœå‹™
- **Docker** + **LocalStack** å®¹å™¨åŒ–é–‹ç™¼
- **pytest** + **coverage** æ¸¬è©¦æ¡†æ¶
