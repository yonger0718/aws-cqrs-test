---
description:
globs:
alwaysApply: false
---
# LocalStack è³‡æ–™åº«é–‹ç™¼æŒ‡å—

## ğŸ³ LocalStack DynamoDB ç’°å¢ƒ

### åŸºæœ¬é…ç½®
- **ç«¯é»**: http://localhost:4566
- **å€åŸŸ**: ap-southeast-1 (é è¨­)
- **èªè­‰**: ä½¿ç”¨æ¸¬è©¦æ†‘è­‰ (test/test)

### å®¹å™¨ç®¡ç†
```bash
# å•Ÿå‹• LocalStack ç’°å¢ƒ
cd query-service
./deploy_docker.sh start

# æª¢æŸ¥ LocalStack ç‹€æ…‹
curl http://localhost:4566/health

# æŸ¥çœ‹å®¹å™¨æ—¥èªŒ
docker logs query-service-localstack-1 -f
```

## ğŸ“Š è¡¨æ ¼åˆå§‹åŒ–èˆ‡ç®¡ç†

### è‡ªå‹•åˆå§‹åŒ–è…³æœ¬
- **ä¸»è…³æœ¬**: [setup.sh](mdc:query-service/infra/localstack/setup.sh)
- **Docker ç‰ˆæœ¬**: [setup_docker.sh](mdc:query-service/infra/localstack/setup_docker.sh)

### æ‰‹å‹•è¡¨æ ¼ç®¡ç†
```bash
# åˆ—å‡ºæ‰€æœ‰è¡¨æ ¼
awslocal dynamodb list-tables --endpoint-url http://localhost:4566

# æª¢æŸ¥è¡¨æ ¼çµæ§‹
awslocal dynamodb describe-table --table-name notification-records --endpoint-url http://localhost:4566

# åˆªé™¤è¡¨æ ¼ (é‡ç½®)
awslocal dynamodb delete-table --table-name command-records --endpoint-url http://localhost:4566
awslocal dynamodb delete-table --table-name notification-records --endpoint-url http://localhost:4566
```

## ğŸ§ª æ¸¬è©¦è³‡æ–™ç®¡ç†

### æ’å…¥æ¸¬è©¦è³‡æ–™
```bash
# ä½¿ç”¨ setup è…³æœ¬çš„æ¸¬è©¦è³‡æ–™
./query-service/infra/localstack/setup.sh

# æ‰‹å‹•æ’å…¥è³‡æ–™
awslocal dynamodb put-item \
  --table-name command-records \
  --item '{
    "transaction_id": {"S": "tx-test-001"},
    "created_at": {"N": "1732000000"},
    "notification_title": {"S": "Test Notification"},
    "notification_body": {"S": "This is a test notification"},
    "status": {"S": "SENT"},
    "platform": {"S": "IOS"},
    "ap_id": {"S": "ap-001"},
    "sns_id": {"S": "sns-test-001"}
  }' \
  --endpoint-url http://localhost:4566
```

### æŸ¥è©¢æ¸¬è©¦è³‡æ–™
```bash
# æŸ¥è©¢ç‰¹å®šè¨˜éŒ„
awslocal dynamodb get-item \
  --table-name notification-records \
  --key '{"transaction_id": {"S": "tx-test-001"}}' \
  --endpoint-url http://localhost:4566

# æƒæè¡¨æ ¼å…§å®¹
awslocal dynamodb scan \
  --table-name notification-records \
  --endpoint-url http://localhost:4566

# æŸ¥è©¢å¤±æ•—è¨˜éŒ„
awslocal dynamodb scan \
  --table-name notification-records \
  --filter-expression "#status = :failed_status" \
  --expression-attribute-names '{"#status": "status"}' \
  --expression-attribute-values '{":failed_status": {"S": "FAILED"}}' \
  --endpoint-url http://localhost:4566
```

## ğŸ”„ Stream æ¸¬è©¦èˆ‡ç›£æ§

### æª¢æŸ¥ Stream é…ç½®
```bash
# æª¢æŸ¥ Stream ç‹€æ…‹
awslocal dynamodb describe-table \
  --table-name command-records \
  --query 'Table.StreamSpecification' \
  --endpoint-url http://localhost:4566

# ç²å– Stream ARN
awslocal dynamodb describe-table \
  --table-name command-records \
  --query 'Table.LatestStreamArn' \
  --output text \
  --endpoint-url http://localhost:4566
```

### Stream è™•ç†æ¸¬è©¦
```bash
# æŸ¥çœ‹ Stream Processor Lambda æ—¥èªŒ
docker logs query-service-stream-processor-lambda-1 -f

# æ‰‹å‹•è§¸ç™¼ Stream è™•ç† (æ’å…¥æ¸¬è©¦è³‡æ–™)
awslocal dynamodb put-item \
  --table-name command-records \
  --item file://query-service/test-events/test-item.json \
  --endpoint-url http://localhost:4566
```

## ğŸ› ï¸ é–‹ç™¼å·¥å…·èˆ‡é™¤éŒ¯

### å¸¸ç”¨ awslocal æŒ‡ä»¤
```bash
# è¡¨æ ¼æ“ä½œ
awslocal dynamodb list-tables
awslocal dynamodb describe-table --table-name [TABLE_NAME]
awslocal dynamodb scan --table-name [TABLE_NAME] --select COUNT

# Lambda æ“ä½œ
awslocal lambda list-functions
awslocal lambda invoke --function-name [FUNCTION_NAME] output.json

# API Gateway æ“ä½œ
awslocal apigateway get-rest-apis
```

### è³‡æ–™ä¸€è‡´æ€§æª¢æŸ¥
```bash
# æ¯”è¼ƒå…©è¡¨è¨˜éŒ„æ•¸
COMMAND_COUNT=$(awslocal dynamodb scan --table-name command-records --select COUNT --endpoint-url http://localhost:4566 --output text --query 'Count')
QUERY_COUNT=$(awslocal dynamodb scan --table-name notification-records --select COUNT --endpoint-url http://localhost:4566 --output text --query 'Count')

echo "Command records: $COMMAND_COUNT"
echo "Query records: $QUERY_COUNT"
```

### æ•ˆèƒ½æ¸¬è©¦
```bash
# æ‰¹é‡æ’å…¥æ¸¬è©¦è³‡æ–™
for i in {1..10}; do
  awslocal dynamodb put-item \
    --table-name command-records \
    --item "{\"transaction_id\": {\"S\": \"tx-batch-$i\"}, \"created_at\": {\"N\": \"$(date +%s)\"}, \"notification_title\": {\"S\": \"Batch Test $i\"}, \"notification_body\": {\"S\": \"Test message $i\"}, \"status\": {\"S\": \"SENT\"}, \"platform\": {\"S\": \"IOS\"}, \"ap_id\": {\"S\": \"ap-batch\"}}" \
    --endpoint-url http://localhost:4566
done
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ
1. **è¡¨æ ¼ä¸å­˜åœ¨**
   ```bash
   # é‡æ–°åŸ·è¡Œåˆå§‹åŒ–
   ./query-service/infra/localstack/setup.sh
   ```

2. **Stream è™•ç†å¤±æ•—**
   ```bash
   # æª¢æŸ¥ Lambda å‡½æ•¸ç‹€æ…‹
   docker logs query-service-stream-processor-lambda-1 --tail 50

   # é‡æ–°éƒ¨ç½² Lambda
   cd query-service
   ./deploy_docker.sh deploy
   ```

3. **é€£æ¥è¶…æ™‚**
   ```bash
   # æª¢æŸ¥ LocalStack å¥åº·ç‹€æ…‹
   curl http://localhost:4566/health

   # é‡å•Ÿ LocalStack
   docker restart query-service-localstack-1
   ```

### å®Œå…¨é‡ç½®ç’°å¢ƒ
```bash
# åœæ­¢ä¸¦æ¸…ç†æ‰€æœ‰å®¹å™¨
cd query-service
docker-compose down -v

# é‡æ–°å•Ÿå‹•ä¸¦åˆå§‹åŒ–
./deploy_docker.sh start
./infra/localstack/setup.sh
```

## ğŸ“ˆ é–‹ç™¼æœ€ä½³å¯¦è¸

### æ¸¬è©¦è³‡æ–™å‘½åè¦ç¯„
- **Transaction ID**: `tx-[type]-[number]` (ä¾‹ï¼štx-test-001, tx-failed-002)
- **SNS ID**: `sns-[type]-[number]` (ä¾‹ï¼šsns-test-001, sns-batch-002)
- **AP ID**: `ap-[type]` (ä¾‹ï¼šap-test, ap-batch)

### ç’°å¢ƒè®Šæ•¸è¨­ç½®
```bash
# LocalStack ç›¸é—œ
export LOCALSTACK_ENDPOINT=http://localhost:4566
export AWS_DEFAULT_REGION=ap-southeast-1
export AWS_ACCESS_KEY_ID=test
export AWS_SECRET_ACCESS_KEY=test

# è¡¨æ ¼åç¨±
export NOTIFICATION_TABLE_NAME=notification-records
export COMMAND_TABLE_NAME=command-records
```

### æ—¥èªŒç›£æ§
```bash
# ç›£æ§æ‰€æœ‰ç›¸é—œæœå‹™æ—¥èªŒ
docker logs query-service-localstack-1 -f &
docker logs query-service-eks-handler-1 -f &
docker logs query-service-stream-processor-lambda-1 -f &
```
