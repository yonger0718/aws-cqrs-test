---
description: when needs to query
globs:
alwaysApply: false
---
# DynamoDB è³‡æ–™åº«å¸ƒå±€æŒ‡å—

## ğŸ“Š CQRS è¡¨çµæ§‹æ¦‚è¿°

æœ¬å°ˆæ¡ˆå¯¦ç¾å®Œæ•´çš„ CQRS æ¨¡å¼ï¼Œä½¿ç”¨å…©å€‹ç¨ç«‹çš„ DynamoDB è¡¨åˆ†é›¢è®€å¯«æ“ä½œï¼š

1. **`command-records`** - Command Side (å¯«å…¥ç«¯)
2. **`notification-records`** - Query Side (æŸ¥è©¢ç«¯)

## ğŸ“ Command Side - `command-records` è¡¨

### ä¸»éµè¨­è¨ˆ
- **Partition Key**: `transaction_id` (String) - äº¤æ˜“å”¯ä¸€è­˜åˆ¥ç¢¼
- **Sort Key**: `created_at` (Number) - å‰µå»ºæ™‚é–“æˆ³ (æ¯«ç§’)

### è¡¨å±¬æ€§
- **Stream**: å•Ÿç”¨ DynamoDB Stream (`NEW_AND_OLD_IMAGES`)
- **è¨ˆè²»æ¨¡å¼**: PAY_PER_REQUEST (æŒ‰éœ€è¨ˆè²»)
- **Stream æª¢è¦–é¡å‹**: NEW_AND_OLD_IMAGES

### å®Œæ•´æ¬„ä½çµæ§‹
```json
{
  "transaction_id": "String",      // äº¤æ˜“ID (ä¸»éµ)
  "created_at": "Number",          // æ™‚é–“æˆ³ (æ’åºéµ)
  "notification_title": "String", // é€šçŸ¥æ¨™é¡Œ
  "notification_body": "String",  // é€šçŸ¥å…§å®¹
  "status": "String",             // SENT | DELIVERED | FAILED
  "platform": "String",          // IOS | ANDROID | WEBPUSH
  "device_token": "String",       // è¨­å‚™æ¨æ’­ä»¤ç‰Œ
  "payload": "String",            // JSON æ ¼å¼çš„æ¨æ’­å…§å®¹
  "error_msg": "String",          // éŒ¯èª¤è¨Šæ¯ (å¤±æ•—æ™‚)
  "ap_id": "String",              // ä¾†æºæœå‹™è­˜åˆ¥ç¢¼
  "sns_id": "String",             // SNS æ¨æ’­è­˜åˆ¥ç¢¼
  "retry_cnt": "Number",          // é‡é€æ¬¡æ•¸
  "send_ts": "Number",            // é€å‡ºæ™‚é–“æˆ³
  "delivered_ts": "Number",       // é€é”æ™‚é–“æˆ³
  "failed_ts": "Number"           // å¤±æ•—æ™‚é–“æˆ³
}
```

**ç”¨é€”**: å°ˆé–€è™•ç†å¯«å…¥æ“ä½œï¼Œè§¸ç™¼ Stream äº‹ä»¶é€²è¡Œç•°æ­¥åŒæ­¥

## ğŸ” Query Side - `notification-records` è¡¨

### ä¸»éµè¨­è¨ˆ
- **Partition Key**: `transaction_id` (String) - äº¤æ˜“å”¯ä¸€è­˜åˆ¥ç¢¼

### å®Œæ•´æ¬„ä½çµæ§‹
```json
{
  "transaction_id": "String",     // äº¤æ˜“ID (ä¸»éµ)
  "created_at": "Number",         // å‰µå»ºæ™‚é–“æˆ³
  "notification_title": "String", // é€šçŸ¥æ¨™é¡Œ
  "notification_body": "String",  // é€šçŸ¥å…§å®¹
  "status": "String",             // SENT | DELIVERED | FAILED
  "platform": "String",          // IOS | ANDROID | WEBPUSH
  "error_msg": "String",          // éŒ¯èª¤è¨Šæ¯ (å¤±æ•—æ™‚ï¼Œå¯é¸)
  "ap_id": "String",              // ä¾†æºæœå‹™è­˜åˆ¥ç¢¼
  "sns_id": "String",             // SNS æ¨æ’­è­˜åˆ¥ç¢¼
  "retry_cnt": "Number",          // é‡é€æ¬¡æ•¸
  "send_ts": "Number",            // é€å‡ºæ™‚é–“æˆ³
  "delivered_ts": "Number",       // é€é”æ™‚é–“æˆ³
  "failed_ts": "Number"           // å¤±æ•—æ™‚é–“æˆ³
}
```

**ç”¨é€”**: å°ˆé–€è™•ç†æŸ¥è©¢æ“ä½œï¼Œæä¾›æœ€ä½³åŒ–çš„è®€å–æ•ˆèƒ½

## ğŸ”„ è³‡æ–™åŒæ­¥æ©Ÿåˆ¶

**æµç¨‹**: `command-records` â†’ DynamoDB Stream â†’ [stream_processor_lambda](mdc:query-service/lambdas/stream_processor_lambda/app.py) â†’ `notification-records`

**å®šç¾©æ–‡ä»¶**:
- [LocalStack è¨­ç½®](mdc:query-service/infra/localstack/setup.sh)
- [Docker è¨­ç½®](mdc:query-service/infra/localstack/setup_docker.sh)
- [è³‡æ–™æ¨¡å‹å®šç¾©](mdc:query-service/lambdas/stream_processor_lambda/app.py)

## ğŸ—ï¸ è¡¨æ ¼å»ºç«‹ç¯„ä¾‹

### LocalStack ç’°å¢ƒå»ºç«‹æŒ‡ä»¤
```bash
# Command Table (å¯«å…¥å´)
awslocal dynamodb create-table \
    --table-name command-records \
    --attribute-definitions \
        AttributeName=transaction_id,AttributeType=S \
        AttributeName=created_at,AttributeType=N \
    --key-schema \
        AttributeName=transaction_id,KeyType=HASH \
        AttributeName=created_at,KeyType=RANGE \
    --billing-mode PAY_PER_REQUEST \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES

# Query Table (è®€å–å´)
awslocal dynamodb create-table \
    --table-name notification-records \
    --attribute-definitions \
        AttributeName=transaction_id,AttributeType=S \
        AttributeName=status,AttributeType=S \
        AttributeName=created_at,AttributeType=N \
    --key-schema \
        AttributeName=transaction_id,KeyType=HASH \
    --global-secondary-indexes \
        IndexName=status-index,KeySchema=[{AttributeName=status,KeyType=HASH},{AttributeName=created_at,KeyType=RANGE}],Projection={ProjectionType=ALL} \
    --billing-mode PAY_PER_REQUEST
```
