---
description: when needs to query
globs:
alwaysApply: false
---
# DynamoDB è³‡æ–™åº«å¸ƒå±€æŒ‡å—

## ğŸ“Š CQRS è¡¨çµæ§‹æ¦‚è¿°

æœ¬å°ˆæ¡ˆå¯¦ç¾å®Œæ•´çš„ CQRS æ¨¡å¼ï¼Œä½¿ç”¨å…©å€‹ç¨ç«‹çš„ DynamoDB è¡¨åˆ†é›¢è®€å¯«æ“ä½œï¼š

1. **`command-records`** - Command Side (å¯«å…¥ç«¯)
2. **`notification-records`** - Query Side (æŸ¥è©¢ç«¯)

## ğŸ“ Command Side - `command-records` è¡¨

### ä¸»éµè¨­è¨ˆ
- **Partition Key**: `transaction_id` (String) - äº¤æ˜“å”¯ä¸€è­˜åˆ¥ç¢¼
- **Sort Key**: `created_at` (Number) - å‰µå»ºæ™‚é–“æˆ³ (æ¯«ç§’)

### è¡¨å±¬æ€§
- **Stream**: å•Ÿç”¨ DynamoDB Stream (`NEW_AND_OLD_IMAGES`)
- **è®€å–å®¹é‡**: 5 RCU / **å¯«å…¥å®¹é‡**: 5 WCU

### å®Œæ•´æ¬„ä½çµæ§‹
```json
{
  "transaction_id": "String",      // äº¤æ˜“ID (ä¸»éµ)
  "created_at": "Number",          // æ™‚é–“æˆ³ (æ’åºéµ)
  "user_id": "String",            // ç”¨æˆ¶ID
  "marketing_id": "String",       // è¡ŒéŠ·æ´»å‹•ID (å¯é¸)
  "notification_title": "String", // é€šçŸ¥æ¨™é¡Œ
  "status": "String",             // SENT | DELIVERED | FAILED
  "platform": "String",          // IOS | ANDROID | WEBPUSH
  "device_token": "String",       // è¨­å‚™æ¨æ’­ä»¤ç‰Œ
  "payload": "String",            // JSON æ ¼å¼çš„æ¨æ’­å…§å®¹
  "error_msg": "String"           // éŒ¯èª¤è¨Šæ¯ (å¤±æ•—æ™‚)
}
```

**ç”¨é€”**: å°ˆé–€è™•ç†å¯«å…¥æ“ä½œï¼Œè§¸ç™¼ Stream äº‹ä»¶é€²è¡Œç•°æ­¥åŒæ­¥

## ğŸ” Query Side - `notification-records` è¡¨

### ä¸»éµè¨­è¨ˆ
- **Partition Key**: `user_id` (String) - ç”¨æˆ¶ID
- **Sort Key**: `created_at` (Number) - å‰µå»ºæ™‚é–“æˆ³ (æ¯«ç§’)

### å…¨åŸŸäºŒç´šç´¢å¼• (GSI)

#### 1. `marketing_id-index`
- **Partition Key**: `marketing_id` (String)
- **Sort Key**: `created_at` (Number)
- **ç”¨é€”**: æŒ‰è¡ŒéŠ·æ´»å‹•æŸ¥è©¢æ¨æ’­è¨˜éŒ„

#### 2. `transaction_id-status-index`
- **Partition Key**: `transaction_id` (String)
- **Sort Key**: `status` (String)
- **ç”¨é€”**: æŒ‰äº¤æ˜“IDå’Œç‹€æ…‹æŸ¥è©¢å¤±æ•—è¨˜éŒ„

### å®Œæ•´æ¬„ä½çµæ§‹
```json
{
  "user_id": "String",            // ç”¨æˆ¶ID (ä¸»éµ)
  "created_at": "Number",         // æ™‚é–“æˆ³ (æ’åºéµ)
  "transaction_id": "String",     // äº¤æ˜“ID (ç”¨æ–¼ç´¢å¼•)
  "marketing_id": "String",       // è¡ŒéŠ·æ´»å‹•ID (ç”¨æ–¼ç´¢å¼•)
  "notification_title": "String", // é€šçŸ¥æ¨™é¡Œ
  "status": "String",             // SENT | DELIVERED | FAILED
  "platform": "String",          // IOS | ANDROID | WEBPUSH
  "error_msg": "String"           // éŒ¯èª¤è¨Šæ¯ (å¤±æ•—æ™‚ï¼Œå¯é¸)
}
```

**ç”¨é€”**: å°ˆé–€è™•ç†æŸ¥è©¢æ“ä½œï¼Œæä¾›æœ€ä½³åŒ–çš„è®€å–æ•ˆèƒ½

## ğŸ”„ è³‡æ–™åŒæ­¥æ©Ÿåˆ¶

**æµç¨‹**: `command-records` â†’ DynamoDB Stream â†’ [stream_processor_lambda](mdc:query-service/lambdas/stream_processor_lambda/app.py) â†’ `notification-records`

**å®šç¾©æ–‡ä»¶**: [setup.sh](mdc:query-service/infra/localstack/setup.sh)
