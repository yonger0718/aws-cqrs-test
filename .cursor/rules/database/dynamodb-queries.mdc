---
description: when needs to query
globs:
alwaysApply: false
---
# DynamoDB æŸ¥è©¢æ¨¡å¼æŒ‡å—

## ğŸ“‹ ä¸»è¦æŸ¥è©¢æ¨¡å¼ (åŸºæ–¼å¯¦éš›å¯¦ç¾)

### 1. æŒ‰äº¤æ˜“IDæŸ¥è©¢ (Primary Query Pattern)
```python
# ä¸»éµæŸ¥è©¢ - ä½¿ç”¨ transaction_id ä½œç‚ºå”¯ä¸€éµæŸ¥è©¢å–®ç­†è¨˜éŒ„
table.get_item(Key={"transaction_id": "tx_001"})

# æ‰¹é‡æŸ¥è©¢æ‰€æœ‰è¨˜éŒ„ (ç„¡ç‰¹å®šéæ¿¾æ¢ä»¶)
table.scan(
    ProjectionExpression="transaction_id, device_token, platform, notification_title, "
                        "notification_body, #status, send_ts, delivered_ts, "
                        "failed_ts, ap_id, created_at, sns_id, retry_cnt",
    ExpressionAttributeNames={"#status": "status"},
    Limit=30
)
```

### 2. å¤±æ•—è¨˜éŒ„æŸ¥è©¢ (Failed Notifications Query)
```python
# æŸ¥è©¢ç‰¹å®šäº¤æ˜“çš„å¤±æ•—è¨˜éŒ„
response = table.get_item(Key={"transaction_id": transaction_id})
item = response.get("Item")
if item and item.get("status") == "FAILED":
    return [item]

# æŸ¥è©¢æ‰€æœ‰å¤±æ•—è¨˜éŒ„ (ä½¿ç”¨ scan + filter)
table.scan(
    FilterExpression=Attr("status").eq("FAILED"),
    ProjectionExpression="transaction_id, device_token, platform, notification_title, "
                        "notification_body, #status, send_ts, delivered_ts, "
                        "failed_ts, ap_id, created_at, retry_cnt",
    ExpressionAttributeNames={"#status": "status"}
)

# å¦‚æœæœ‰ status-index GSIï¼Œå¯ä»¥ä½¿ç”¨ query (æ•ˆèƒ½æ›´å¥½)
table.query(
    IndexName='status-index',
    KeyConditionExpression='#status = :status',
    ExpressionAttributeNames={'#status': 'status'},
    ExpressionAttributeValues={':status': 'FAILED'}
)
```

### 3. SNS æ¨æ’­æŸ¥è©¢ (SNS-based Query)
```python
# ä½¿ç”¨ scan åŠ  filter æŸ¥è©¢ SNS è¨˜éŒ„
table.scan(
    FilterExpression=Attr("sns_id").eq(sns_id),
    ProjectionExpression="transaction_id, device_token, platform, notification_title, "
                        "notification_body, #status, send_ts, delivered_ts, "
                        "failed_ts, ap_id, created_at, sns_id, retry_cnt",
    ExpressionAttributeNames={"#status": "status"}
)
```

## ğŸ¯ æŸ¥è©¢æœ€ä½³åŒ–ç­–ç•¥

### åŸºæ–¼å¯¦éš› API ç«¯é»è¨­è¨ˆ
- **`/tx` ç«¯é»**: ä½¿ç”¨ `get_item` æˆ– `scan` (ä¾æ˜¯å¦æä¾› transaction_id)
- **`/fail` ç«¯é»**: ä½¿ç”¨ `get_item` + status æª¢æŸ¥æˆ– `scan` + filter
- **`/sns` ç«¯é»**: ä½¿ç”¨ `scan` + filter (æ•ˆèƒ½è¼ƒå·®ï¼Œå»ºè­°åŠ å…¥ GSI)

### æ•ˆèƒ½è€ƒé‡
```python
# æ¨è–¦ï¼šä½¿ç”¨ get_item é€²è¡Œé»æŸ¥è©¢ (æœ€å¿«)
table.get_item(Key={"transaction_id": "tx_001"})

# è¬¹æ…ä½¿ç”¨ï¼šscan æ“ä½œ (è¼ƒæ…¢ï¼Œæœƒæƒææ•´è¡¨)
table.scan(FilterExpression=Attr("status").eq("FAILED"))
```

## ğŸ§ª æ¸¬è©¦è³‡æ–™ç¯„ä¾‹ (åŸºæ–¼å¯¦éš›æ¶æ§‹)

### Command Table (`command-records`) æ¸¬è©¦è³‡æ–™
```json
{
  "transaction_id": "tx-ios-001",
  "created_at": 1732000000,
  "notification_title": "Welcome to our app!",
  "notification_body": "Get started with our amazing features!",
  "status": "SENT",
  "platform": "IOS",
  "device_token": "apns-device-token-123",
  "ap_id": "ap-001",
  "sns_id": "sns-12345",
  "retry_cnt": 0,
  "send_ts": 1732000000,
  "delivered_ts": 1732000010
}
```

### Query Table (`notification-records`) åŒæ­¥è³‡æ–™
```json
{
  "transaction_id": "tx-ios-001",
  "created_at": 1732000000,
  "notification_title": "Welcome to our app!",
  "notification_body": "Get started with our amazing features!",
  "status": "SENT",
  "platform": "IOS",
  "ap_id": "ap-001",
  "sns_id": "sns-12345",
  "retry_cnt": 0,
  "send_ts": 1732000000,
  "delivered_ts": 1732000010
}
```

**æ³¨æ„**: Query Side å¯èƒ½æœƒç§»é™¤æ•æ„Ÿæ¬„ä½ (`device_token`, `payload`)

## ğŸ“Š è³‡æ–™ä¸€è‡´æ€§ç›£æ§

### åŒæ­¥ç‹€æ…‹æª¢æŸ¥ (LocalStack)
```bash
# Command Table è¨˜éŒ„æ•¸
awslocal dynamodb scan --table-name command-records --select COUNT --endpoint-url http://localhost:4566

# Query Table è¨˜éŒ„æ•¸
awslocal dynamodb scan --table-name notification-records --select COUNT --endpoint-url http://localhost:4566

# æª¢æŸ¥ Stream ç‹€æ…‹
awslocal dynamodb describe-table --table-name command-records --endpoint-url http://localhost:4566
```

### Stream è™•ç†ç›£æ§
```python
# æª¢æŸ¥ Stream Processor Lambda æ—¥èªŒ
docker logs query-service-stream-processor-lambda-1

# æŸ¥çœ‹è™•ç†ç‹€æ…‹
logger.info(f"Successfully processed {processed}/{len(records)} records")
```

## ğŸ”§ é–‹ç™¼å·¥å…·æŒ‡ä»¤

### æœ¬åœ°æ¸¬è©¦æŸ¥è©¢
```bash
# ä½¿ç”¨å°ˆæ¡ˆæŸ¥è©¢å·¥å…·
./scripts/queries/test_query.sh

# æ‰‹å‹•æ¸¬è©¦ API
curl "http://localhost:8000/tx?transaction_id=tx_001"
curl "http://localhost:8000/fail"
curl "http://localhost:8000/sns?sns_id=sns-12345"
```

### DynamoDB ç›´æ¥æ“ä½œ
```bash
# æ’å…¥æ¸¬è©¦è³‡æ–™
awslocal dynamodb put-item --table-name command-records --item file://test-data.json

# æŸ¥è©¢ç‰¹å®šè¨˜éŒ„
awslocal dynamodb get-item --table-name notification-records --key '{"transaction_id":{"S":"tx_001"}}'
```
