---
description: when needs to query
globs:
alwaysApply: false
---
# æ•¸æ“šå­˜å–æ¨¡å¼æŒ‡å—

## ğŸ”„ CQRS å­˜å–æ¨¡å¼

### å¯«å…¥æ¨¡å¼ (Command Side)
- **è¡¨å**: `command-records`
- **ä¸»è¦æ“ä½œ**: PUT_ITEM (æ–°å¢æ¨æ’­è¨˜éŒ„)
- **è§¸ç™¼**: æ¨æ’­æœå‹™å¯«å…¥å‘½ä»¤
- **å¾ŒçºŒ**: è‡ªå‹•è§¸ç™¼ DynamoDB Stream

### è®€å–æ¨¡å¼ (Query Side)
- **è¡¨å**: `notification-records`
- **ä¸»è¦æ“ä½œ**: QUERY (ç”¨æˆ¶æŸ¥è©¢ã€æ´»å‹•çµ±è¨ˆ)
- **ç´¢å¼•ä½¿ç”¨**: ä¸»è¡¨ + 2å€‹GSI
- **è³‡æ–™ä¾†æº**: Stream åŒæ­¥çš„æœ€ä½³åŒ–è³‡æ–™

## ğŸ“Š æŸ¥è©¢å­˜å–æ¨¡å¼

### æ¨¡å¼1: ç”¨æˆ¶æ¨æ’­æ­·å²æŸ¥è©¢
```python
# å­˜å–è·¯å¾‘: notification-records ä¸»è¡¨
response = table.query(
    KeyConditionExpression=Key('user_id').eq(user_id),
    ScanIndexForward=False,  # æœ€æ–°è¨˜éŒ„å„ªå…ˆ
    Limit=20  # åˆ†é æŸ¥è©¢
)
```

### æ¨¡å¼2: è¡ŒéŠ·æ´»å‹•æ•ˆæœåˆ†æ
```python
# å­˜å–è·¯å¾‘: marketing_id-index GSI
response = table.query(
    IndexName='marketing_id-index',
    KeyConditionExpression=Key('marketing_id').eq(campaign_id),
    FilterExpression=Attr('status').eq('DELIVERED')
)
```

### æ¨¡å¼3: å¤±æ•—è¨˜éŒ„æ’æŸ¥
```python
# å­˜å–è·¯å¾‘: transaction_id-status-index GSI
response = table.query(
    IndexName='transaction_id-status-index',
    KeyConditionExpression=Key('transaction_id').eq(tx_id) & Key('status').eq('FAILED')
)
```

## ğŸ› ï¸ å¯¦ä½œåƒè€ƒæ–‡ä»¶

- **Stream è™•ç†**: [stream_processor_lambda/app.py](mdc:query-service/lambdas/stream_processor_lambda/app.py)
- **æŸ¥è©¢å¯¦ä½œ**: [query_result_lambda/app.py](mdc:query-service/lambdas/query_result_lambda/app.py)
- **è¡¨çµæ§‹å®šç¾©**: [setup.sh](mdc:query-service/infra/localstack/setup.sh)
- **æ¸¬è©¦é©—è­‰**: [test_integration.py](mdc:query-service/tests/test_integration.py)

## âš¡ æ•ˆèƒ½å„ªåŒ–å»ºè­°

- ä½¿ç”¨ BatchGetItem é€²è¡Œæ‰¹é‡æŸ¥è©¢
- å–„ç”¨ FilterExpression æ¸›å°‘å‚³è¼¸è³‡æ–™
- å®šæœŸç›£æ§ GSI ç†±é»åˆ†å€
