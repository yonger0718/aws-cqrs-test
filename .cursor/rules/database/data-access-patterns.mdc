---
description: when needs to query
globs:
alwaysApply: false
---
# æ•¸æ“šå­˜å–æ¨¡å¼æŒ‡å—

## ğŸ”„ CQRS å­˜å–æ¨¡å¼ (åŸºæ–¼å¯¦éš›æ¶æ§‹)

### å¯«å…¥æ¨¡å¼ (Command Side)
- **è¡¨å**: `command-records`
- **ä¸»éµ**: `transaction_id` (HASH) + `created_at` (RANGE)
- **ä¸»è¦æ“ä½œ**: PUT_ITEM (æ–°å¢æ¨æ’­è¨˜éŒ„)
- **è§¸ç™¼**: æ¨æ’­æœå‹™å¯«å…¥å‘½ä»¤
- **å¾ŒçºŒ**: è‡ªå‹•è§¸ç™¼ DynamoDB Stream
- **Stream é…ç½®**: `NEW_AND_OLD_IMAGES`

### è®€å–æ¨¡å¼ (Query Side)
- **è¡¨å**: `notification-records`
- **ä¸»éµ**: `transaction_id` (HASH å”¯ä¸€éµ)
- **ä¸»è¦æ“ä½œ**: GET_ITEMã€SCAN (ç¾æœ‰å¯¦ç¾)
- **ç´¢å¼•ä½¿ç”¨**: ä¸»è¡¨ + GSI (status-index å¯é¸)
- **è³‡æ–™ä¾†æº**: Stream åŒæ­¥çš„æœ€ä½³åŒ–è³‡æ–™

## ğŸ“Š å¯¦éš›æŸ¥è©¢å­˜å–æ¨¡å¼

### æ¨¡å¼1: äº¤æ˜“æ¨æ’­æŸ¥è©¢ (`/tx` ç«¯é»)
```python
# å­˜å–è·¯å¾‘: notification-records ä¸»è¡¨ - GET_ITEM
# å¯¦ç¾æ–¼: QueryService.query_transaction_notifications()
if transaction_id:
    response = table.get_item(Key={"transaction_id": transaction_id})
else:
    # æŸ¥è©¢æœ€è¿‘è¨˜éŒ„ - SCAN
    response = table.scan(Limit=limit)
```

### æ¨¡å¼2: å¤±æ•—è¨˜éŒ„æŸ¥è©¢ (`/fail` ç«¯é»)
```python
# å­˜å–è·¯å¾‘: notification-records ä¸»è¡¨ - GET_ITEM + SCAN
# å¯¦ç¾æ–¼: QueryService.query_failed_notifications()
if transaction_id:
    response = table.get_item(Key={"transaction_id": transaction_id})
    # æª¢æŸ¥ status == "FAILED"
else:
    response = table.scan(FilterExpression=Attr("status").eq("FAILED"))
```

### æ¨¡å¼3: SNS æ¨æ’­æŸ¥è©¢ (`/sns` ç«¯é»)
```python
# å­˜å–è·¯å¾‘: notification-records ä¸»è¡¨ - SCAN + FILTER
# å¯¦ç¾æ–¼: QueryService.query_sns_notifications()
response = table.scan(
    FilterExpression=Attr("sns_id").eq(sns_id),
    ProjectionExpression="transaction_id, #token, platform, ..."
)
```

## ğŸ”„ Stream è³‡æ–™åŒæ­¥æ¨¡å¼

### Stream è™•ç†æµç¨‹
```python
# å¯¦ç¾æ–¼: stream_processor_lambda/app.py
def process_stream_record(record):
    # 1. è§£æ Command Record
    command_record = parse_command_record(new_image)

    # 2. è½‰æ›ç‚º Query Record
    query_record = transform_to_query_record(command_record)

    # 3. å„²å­˜è‡³ Query Side
    save_query_record(query_record)
```

### è³‡æ–™è½‰æ›è¦å‰‡
```python
# CommandRecord â†’ QueryRecord
# ç§»é™¤æ•æ„Ÿæ¬„ä½: device_token, payload
# ä¿ç•™æŸ¥è©¢æ¬„ä½: transaction_id, status, platform, etc.
def transform_to_query_record(command_record):
    return QueryRecord(
        transaction_id=command_record.transaction_id,
        created_at=command_record.created_at,
        status=command_record.status,
        platform=command_record.platform,
        # ... å…¶ä»–éæ•æ„Ÿæ¬„ä½
    )
```

## ğŸ› ï¸ å¯¦ä½œåƒè€ƒæ–‡ä»¶

### æ ¸å¿ƒå¯¦ç¾
- **FastAPI æŸ¥è©¢æœå‹™**: [main.py](mdc:query-service/eks_handler/main.py) - QueryService é¡åˆ¥
- **Stream è™•ç†å™¨**: [stream_processor_lambda/app.py](mdc:query-service/lambdas/stream_processor_lambda/app.py)
- **Lambda æŸ¥è©¢è™•ç†**: [query_result_lambda/app.py](mdc:query-service/lambdas/query_result_lambda/app.py)

### é…ç½®èˆ‡è¨­ç½®
- **LocalStack è¡¨æ ¼è¨­ç½®**: [setup.sh](mdc:query-service/infra/localstack/setup.sh)
- **Docker ç’°å¢ƒ**: [setup_docker.sh](mdc:query-service/infra/localstack/setup_docker.sh)

### æ¸¬è©¦èˆ‡é©—è­‰
- **æ•´åˆæ¸¬è©¦**: [test_integration.py](mdc:query-service/tests/test_integration.py)
- **Lambda æ¸¬è©¦**: [test_lambdas/](mdc:query-service/tests/test_lambdas)
- **æ¸¬è©¦äº‹ä»¶**: [test-events/](mdc:query-service/test-events)

## âš¡ æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

### æŸ¥è©¢æœ€ä½³åŒ–
```python
# æ¨è–¦ï¼šé»æŸ¥è©¢ (æœ€å¿«)
table.get_item(Key={"transaction_id": "tx_001"})

# è¬¹æ…ï¼šå…¨è¡¨æƒæ (è¼ƒæ…¢)
table.scan(FilterExpression=Attr("status").eq("FAILED"))

# å»ºè­°ï¼šå¢åŠ  GSI ç´¢å¼•
# sns_id æŸ¥è©¢å¯èƒ½éœ€è¦å°ˆç”¨ GSI ä¾†æå‡æ•ˆèƒ½
```

### è³‡æ–™å‚³è¼¸æœ€ä½³åŒ–
```python
# ä½¿ç”¨ ProjectionExpression æ¸›å°‘å‚³è¼¸é‡
ProjectionExpression="transaction_id, #token, platform, notification_title"

# ä½¿ç”¨ ExpressionAttributeNames è™•ç†ä¿ç•™å­—
ExpressionAttributeNames={"#token": "token", "#status": "status"}
```

### ç›£æ§èˆ‡é™¤éŒ¯
```bash
# æª¢æŸ¥ Stream è™•ç†ç‹€æ…‹
docker logs query-service-stream-processor-lambda-1

# ç›£æ§è¡¨æ ¼å¤§å°
awslocal dynamodb describe-table --table-name notification-records

# é©—è­‰è³‡æ–™åŒæ­¥
./scripts/testing/test_full_flow.sh
```

## ğŸ¯ é–‹ç™¼å»ºè­°

### æ–°å¢æŸ¥è©¢æ¨¡å¼
1. è©•ä¼°æ˜¯å¦éœ€è¦æ–°çš„ GSI
2. è€ƒæ…®æŸ¥è©¢é »ç‡å’Œæ•ˆèƒ½éœ€æ±‚
3. æ›´æ–° Stream è™•ç†é‚è¼¯ (å¦‚éœ€è¦)
4. æ·»åŠ ç›¸æ‡‰çš„æ¸¬è©¦æ¡ˆä¾‹

### æ•ˆèƒ½ç›£æ§é‡é»
- **Command Side**: å¯«å…¥å»¶é²ã€Stream è™•ç†æˆåŠŸç‡
- **Query Side**: æŸ¥è©¢å»¶é²ã€scan æ“ä½œé »ç‡
- **è³‡æ–™ä¸€è‡´æ€§**: å…©å´è³‡æ–™åŒæ­¥ç‡
